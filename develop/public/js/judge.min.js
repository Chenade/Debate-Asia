$(document).ready(function() {
    var object = {};
    // $('body').css('overflow', 'hidden');

    var download_file = function(text, filename)
    {
        var blob = new Blob([text], { type: "text/plain" });

        var link = document.createElement("a");
            link.href = URL.createObjectURL(blob);

            link.download = (filename + ".txt");
            link.innerHTML = "Download";

        document.body.appendChild(link);

        link.click();
        link.remove();
    };

    ajax('GET', '/api/judges/info', {}, function (a) {
        // console.log(a);
        if (a.success)
        {
            $('#name').html(a.data.name_cn);
            $('#account').html(a.data.account);
            $('#email').html(a.data.email);
        }
        else
        {
            $.growl.error({message: a.message})
            setTimeout(() => {
                window.location.href = "/";
            }, 500);
        }
    });

    // get cookie
    ajax('GET', '/api/judges/list', {}, function (a) {
        if(a.success){
            object = a.data;
            $('#groups_lst').empty();
            $('#rounds_lst').empty();
            for (const i in a.data)
            {
                // console.log(a.data[i]);
                for (const j in a.data[i].groups)
                {
                    
                    for (const k in a.data[i].groups[j].sessions)
                    {
                        for (const l in a.data[i].groups[j].sessions[k].rounds)
                        {
                            if (a.data[i].groups[j].sessions[k].rounds[l].status == 0)
                            {
                                $('#groups_lst').append(`
                                    <div class="col-11 bg-dark" style="min-height: 80px; margin: 10px; padding: 1em; color: #FFFFFF;" 
                                        data-competition_id="${a.data[i].competition_id}" data-group_id="${a.data[i].groups[j].group_id}">
                                        <h5 class="mb-0 mt-0" style="color: #FFFFFF;">${a.data[i].competition_name}</h5>
                                        <h6 class="mb-0 mt-0" style="color: #FFFFFF;">${a.data[i].groups[j].group_name}</h6>
                                    </div>
                                `);
                                $('#rounds_lst').append(`
                                    <div class="col-11 bg-dark" style="min-height: 80px; margin: 10px; padding: 1em; color: #FFFFFF;" data-id="${k}">
                                            <h5 class="mb-0 mt-0" style="color: #FFFFFF;">${a.data[i].groups[j].sessions[k].session_name}</h5>
                                            <p class="pl-3 mb-0 mt-0" style="color: #FFFFFF;">正方辯題：${a.data[i].groups[j].sessions[k].rounds[l].pos_title}</p>
                                            <p class="pl-3 mb-0 mt-0" style="color: #FFFFFF;">反方辯題：${a.data[i].groups[j].sessions[k].rounds[l].neg_title}</p>
                                        <hr style="background-color: #FFFFFF; margin: 0.5em 0;">
                                            <div class="d-flex justify-content-between">
                                                <p class="mb-0 mt-0 align-middle" style="color: #FFFFFF;">場次編號：${l}</p>
                                                <button class="btn btn-light mb-0 start-btn" data-session_id="${k}" data-room_number=${l}>開始評分</button>
                                            </div>
                                    </div>
                                `);
                            }
                        }
                    }
                }
            }
        }else
            $.growl.error({message: a.message})
    }); 

    $(document).on('click', '.competition-btn', function () {
        const cid = $(this).data('cid');
        ajax('GET', '/api/judges/' + cid + '/roomlist',  {}, function (a) {
            if(a.success){
                $('#upcomingEvent').empty();
                console.log(a);
                for(const i in a.data.rooms)
                {
                    const _this = a.data.rooms[i][0];
                    const _next = a.data.rooms[i][1];
                    if (_next.judge_note != "（测试场次）" && _this.judge_note != "（测试场次）")
                    {
                        box  = '<div class="col-11 d-flex mt-3 align-items-center" style="background-color: black; min-height: 80px; margin: 10px; padding: 1em; color: #FFFFFF;">';
                        box += '<div class="col-9">'
                            box += '<h5 class="mb-0 mt-0" style="color: #FFFFFF;">';
                            if (_this.status < 4 && _next.status < 4)
                                box += '<span class="badge badge-info">' + langDict['incompetition'] + '</span>&emsp;';
                            else if (_this.status == 4 && _next.status == 4)
                                box += '<span class="badge badge-warning">' + langDict['evalution'] + '</span>&emsp;';
                            else if (_this.status >= 5 && _next.status >= 5)
                                box += '<span class="badge badge-success">' + langDict['evalutionDone'] + '</span>&emsp;';
                            box += '會場編號：' + _this.roomid + '</h5>';
                            if (_next.judge_note)
                                box += '裁判名單：' + _next.judge_note + '</h5>';
                            else if (_this.judge_note)
                                box += '裁判名單：' + _this.judge_note + '</h5>';
                            else
                                box += '裁判名單：</h5>';
                            box += '</div>';
                        box += '<div class="col-3 d-flex align-items-center">'
                            if (_this.status == 4 && _next.status == 4)
                                box += '<button class="btn btn-light start-btn mb-0" data-cid="' + cid + '" data-rid="' + _this.roomid + '">' + langDict['enter'] + langDict['judge'] + '</button>';
                        box += '</div>';
                        box += '</div>';
                        $('#upcomingEvent').append(box);
                    }
                }
    
            }else
                $.growl.error({message: a.message})
        }); 
    });
    
    $(document).on('click', '.start-btn', function () {
        const session_id = $(this).data('session_id');
        const room_number = $(this).data('room_number');
        location.href = "/judge/" + session_id + "/room/" + room_number;
    });

    $(document).on('click', '.download-article-btn', function () {
        
        ajax('GET', '/api/articles/download/' + $(this).data('sid'), {}, function(a){
            var text = "";

                text += langDict['sessionTime'] + '：' + a.data.tag + '\n';
                text += langDict['sessionTime'] + '：' + moment.unix(a.data.date).format("YYYY-MM-DD HH:mm:ss") + '\n';
                text += langDict['title'] + '：\n' + a.data.title.split('$?')[0] + '\n';
                if (a.data.title.split('$?')[1]) text += a.data.title.split('$?')[1] + '\n';

                text += '\n---------------------------------------------------------------------------------\n\n';
                text += langDict['mine'] + langDict['argument'] + '：\n';
                text += trimquotes(a.data.article[0].content);
                
                text += '\n---------------------------------------------------------------------------------\n\n';
                text += langDict['mine'] + langDict['rebuttal'] + '：\n';
                text += trimquotes(a.data.article[1].content);
            
                download_file(text, a.data.tag);
        })
    });
 });