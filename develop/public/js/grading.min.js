$(document).ready(function() {
    const rid = window.location.pathname.split('/')[4];
    const sid = window.location.pathname.split('/')[2];

    var resetSession = function()
    {
        $('.inputTextbox').val("");
        $('.inputbox').val(0);
        $('#pos_argue_content').val("");
        $('#neg_argue_content').val("");
        $('#pos_rebuttal_content').val("");
        $('#neg_rebuttal_content').val("");
        $('.save-btn[data-type="pos"]').data('id', 0);
        $('.save-btn[data-type="neg"]').data('id', 0);
        $('#pos_comment').val("");
        $('#neg_comment').val("");
        for(var i = 1; i < 5; i++){
            $('.pos_score[data-id=' + i + ']').val(0);
            $('.neg_score[data-id=' + i + ']').val(0);
        }
        $('.pos_score[data-id=5]').val(0);
        $('.neg_score[data-id=5]').val(0);
        
    }, renderData = function(type, _this)
    {
        // console.log(type, _this);
        for (const i in _this.article)
        {
            if (_this.article[i].type == 0)
                $('#' + type + '_argue_content').val(translate(trimquotes(_this.article[i].content)));
            if (_this.article[i].type == 1)
                $('#' + type + '_rebuttal_content').val(translate(trimquotes(_this.article[i].content)));
        }
        if (_this.judge)
        {
            $('#'+type+'_comment').val(translate(trimquotes(_this.judge.comment)));
            $('.'+ type +'_score[data-id="1"]').val(_this.judge.score_1);
            $('.'+ type +'_score[data-id="2"]').val(_this.judge.score_2);
            $('.'+ type +'_score[data-id="3"]').val(_this.judge.score_3);
            $('.'+ type +'_score[data-id="4"]').val(_this.judge.score_4);
            $('.'+ type +'_score[data-id="5"]').val(_this.judge.score_1 + _this.judge.score_2 + _this.judge.score_3 + _this.judge.score_4);
        }
        $('.save-btn[data-type="' + type + '"]').data('id', _this.id);
    },
     setSessionInfo = function()
    {
        resetSession();
        ajax('GET', '/api/judges/sessions/' + sid + '/rounds/' + rid + '', {}, function (a) {
            if(a.success){
                $('.info-title').empty();
                $('.info-pos-title').text(translate(a.info.pos_title));
                $('.info-neg-title').text(translate(a.info.neg_title));
                $('.t_write').text(a.info.t_write);
                $('.t_read').text(a.info.t_read);
                $('.t_debate').text(a.info.t_debate);

                for (const i in a.data)
                {
                    const pos = (a.data[i].role == 1) ? a.data[i] : null;
                    const neg = (a.data[i].role == 2) ? a.data[i] : null;
                    if (pos)
                        renderData('pos', pos);
                    if (neg)
                        renderData('neg', neg);
                }
                alert('提醒：評審成功提交評分單前請勿關閉網頁或重新整理網頁');
            }else
            {
                $.growl.error({message: a.message});
                setTimeout(() => {
                    if (a.message == "Judge info not found" )
                        window.location.href = "/judge";
                }, 1000);
            }
        }); 
    }, saveArticle = function(type, id)
    {
        var data = {
            'comment': $('#' + type + 'comment').val(),
            'score_1': $('.' + type + 'score[data-id="1"]').val(),
            'score_2': $('.' + type + 'score[data-id="2"]').val(),
            'score_3': $('.' + type + 'score[data-id="3"]').val(),
            'score_4': $('.' + type + 'score[data-id="4"]').val(),
        };
        // console.log(data);
        ajax('PUT', '/api/judges/submit/' + id, data, function (a) {
            if(a.success){
                // document.cookie = "Authorization="+a.token+"; path=/";
                $.growl.notice({message: '已儲存'})
            }else
                $.growl.error({message: a.message})
        }); 
    };

    setSessionInfo();

    $(document).on('click', '.save-btn', function () {
        type = $(this).data('type') + '_';
        id = $(this).data('id');
        saveArticle(type, id);
    });

    $('.pos_score').on('change', function() {
        var score = 0;
        score = parseInt($('.pos_score[data-id=1]').val());
        score += parseInt($('.pos_score[data-id=2]').val());
        score += parseInt($('.pos_score[data-id=3]').val());
        score += parseInt($('.pos_score[data-id=4]').val());
        $('.pos_score[data-id=5]').val(score);
    });

    $('.neg_score').on('change', function() {
        var score = 0;
        score = parseInt($('.neg_score[data-id=1]').val());
        score += parseInt($('.neg_score[data-id=2]').val());
        score += parseInt($('.neg_score[data-id=3]').val());
        score += parseInt($('.neg_score[data-id=4]').val());
        $('.neg_score[data-id=5]').val(score);
    });

 });