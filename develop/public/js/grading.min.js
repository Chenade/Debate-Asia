$(document).ready(function() {
    const rid = window.location.pathname.split('/')[4];
    const cid = window.location.pathname.split('/')[2];
    var mid = 0, sid = 0, stage = 0, role = null, lastUpdated = null, 
    mainTimer = null, saveArticleTimer = null;

    var updateSession = function(stage)
    {
        var data = {
            'status': stage,
        };
        ajax('PUT', '/api/sessions/' + sid, data, function (a) {
            if(a.success){
                document.cookie = "Authorization="+a.token;
                if (stage == 4)
                {
                    $('.roles').css('display', 'inline');
                    $('#videos').attr('src', '');
                    $.growl.notice({message: '比賽結束!'});
                    setTimeout(() => {
                        window.location.href = "/candidate";
                    }, 3000);
                }
                else{
                    $.growl.notice({message: '已完成此階段，請靜候對手', duration: 10000})
                    setSessionStatus();
                }
            }else
                $.growl.error({message: a.message})
        }); 
    }, setSessionInfo = function()
    {
        $('.inputTextbox').val("");
        $('.inputbox').val(0);
        $('#pos_argue_content').val("");
        $('#neg_argue_content').val("");
        $('#pos_rebuttal_content').val("");
        $('#neg_rebuttal_content').val("");
        $('.save-btn[data-type="pos"]').data('id', 0);
        $('.save-btn[data-type="neg"]').data('id', 0);
        $('#pos_comment').val("");
        $('#neg_comment').val("");
        for(var i = 1; i < 5; i++){
            $('.pos_score[data-id=' + i + ']').val(0);
            $('.neg_score[data-id=' + i + ']').val(0);
        }
        $('.pos_score[data-id=5]').val(a.data.usr[1].judge.sum_score);
        $('.neg_score[data-id=5]').val(a.data.usr[2].judge.sum_score);
        ajax('GET', '/api/judges/sessions/' + cid + '/rooms/' + rid + '/status', {}, function (a) {
            if(a.success){
                console.log(a);
                $('.info-title').empty();
                $('.info-title').append('<h6 class="mt-0 mb-1" style="text-indent: 1em;">' + translate(a.data.competition.title).split('$?')[0] + '</h6>');
                if (a.data.competition.title.split('$?')[1])$('.info-title').append('<h6 class="mt-0 mb-1" style="text-indent: 1em;">' + translate(a.data.competition.title).split('$?')[1] + '</h6>');
                $('.t_write').text(a.data.competition.t_write);
                $('.t_read').text(a.data.competition.t_read);
                $('.t_debate').text(a.data.competition.t_debate);

                $('#pos_argue_content').val(translate(trimquotes(a.data.usr[1].article[0])));
                $('#neg_argue_content').val(translate(trimquotes(a.data.usr[2].article[0])));
                $('#pos_rebuttal_content').val(translate(trimquotes(a.data.usr[1].article[1])));
                $('#neg_rebuttal_content').val(translate(trimquotes(a.data.usr[2].article[1])));
                $('.save-btn[data-type="pos"]').data('id', a.data.usr[1].judge.id);
                $('.save-btn[data-type="neg"]').data('id', a.data.usr[2].judge.id);
                $('#pos_comment').val(a.data.usr[1].judge.comment);
                $('#neg_comment').val(a.data.usr[2].judge.comment);
                for(var i = 1; i < 5; i++){
                    $('.pos_score[data-id=' + i + ']').val(a.data.usr[1].judge.score[i]);
                    $('.neg_score[data-id=' + i + ']').val(a.data.usr[2].judge.score[i]);
                }
                $('.pos_score[data-id=5]').val(a.data.usr[1].judge.sum_score);
                $('.neg_score[data-id=5]').val(a.data.usr[2].judge.sum_score);

                alert('提醒：評審成功提交評分單前請勿關閉網頁或重新整理網頁');
                setInterval(() => {
                    $('.save-btn').click();
                }, 180000);
            }else
            {
                $.growl.error({message: a.message});
                setTimeout(() => {
                    if (a.message == "Judge info not found" )
                        window.location.href = "/judge";
                }, 1000);
            }
        }); 
    }, saveArticle = function(type, id)
    {
        var data = {
            'comment': $('#' + type + 'comment').val(),
            'score_1': $('.' + type + 'score[data-id="1"]').val(),
            'score_2': $('.' + type + 'score[data-id="2"]').val(),
            'score_3': $('.' + type + 'score[data-id="3"]').val(),
            'score_4': $('.' + type + 'score[data-id="4"]').val(),
        };
        ajax('PUT', '/api/judges/submit/' + id, data, function (a) {
            if(a.success){
                document.cookie = "Authorization="+a.token;
                $.growl.notice({message: '已儲存'})
            }else
                $.growl.error({message: a.message})
        }); 
    };

    setSessionInfo();

    $(document).on('click', '.save-btn', function () {
        type = $(this).data('type') + '_';
        id = $(this).data('id');
        saveArticle(type, id);
    });

    $('.pos_score').on('change', function() {
        var score = 0;
        score = parseInt($('.pos_score[data-id=1]').val());
        score += parseInt($('.pos_score[data-id=2]').val());
        score += parseInt($('.pos_score[data-id=3]').val());
        score += parseInt($('.pos_score[data-id=4]').val());
        $('.pos_score[data-id=5]').val(score);
    });

    $('.neg_score').on('change', function() {
        var score = 0;
        score = parseInt($('.neg_score[data-id=1]').val());
        score += parseInt($('.neg_score[data-id=2]').val());
        score += parseInt($('.neg_score[data-id=3]').val());
        score += parseInt($('.neg_score[data-id=4]').val());
        $('.neg_score[data-id=5]').val(score);
    });

 });