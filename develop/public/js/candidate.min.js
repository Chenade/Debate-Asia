$(document).ready(function() {
    $('body').css('overflow', 'hidden');

    const mid = window.location.pathname.split('/')[2];
    ajax('GET', '/api/candidates/list/' + mid, {}, function (a) {
        if(a.success){
            document.cookie = "Authorization="+a.token;
            $('#name').html(a.data.name_cn);
            $('#account').html(a.data.account);
            $('#school_name').html(a.data.school_cn);
            var box = "";
            $('#upcomingEvent').empty();
            $('#pastEvent').empty();
            for (const i in a.data.competition)
            {
                const _this = a.data.competition[i];
                if (_this.status < 4)
                {
                    box = '<div class="col-11" style="background-color: black; height: 180px; margin: 10px; padding: 1em; color: #FFFFFF;">';
                    box += '<h5 class="mb-0 mt-0" style="color: #FFFFFF;">' + _this.tag + '</h5>';
                    box += '<hr>';
                    box += '<div class="d-flex flex-wrap">';
                        box += '<div class="col-12 col-sm-8">';
                            box += '<h5 class="mb-1 mt-0" style="color: #FFFFFF;">' + langDict['sessionTime'] + '：</h5>';
                            box += '<h5 class="mb-1 mt-0" style="color: #FFFFFF;">' + moment.unix(_this.date).format("YYYY 年 MM 月 DD 日 hh:mm") + '</h5>';
                        box += '</div>';
                        const diff = moment.unix(_this.date).diff(new Date(), 'hours');
                        if ( diff < 10 && diff > -120)
                        {
                            box += '<div class="col-12 col-sm-4">';
                                    box += '<div class="d-flex justify-content-center align-items-end"><button class="btn btn-light start-btn" data-id="' + _this.roomid + '">' + langDict['enter'] + langDict['competition'] + '</button><div>';
                            box += '</div>';
                        }
                    box += '</div>';
                    box += '</div>';
                    $('#upcomingEvent').append(box);

                }
                else
                {
                    box = '<div class="col-11" style="background-color: black; min-height: 220px; margin: 10px; padding: 1em; color: #FFFFFF;">';
                    box += '<h5 class="mb-0 mt-0" style="color: #FFFFFF;"><span class="badge badge-warning">冠軍</span>&emsp;' + _this.tag + '</h5>';
                    box += '<hr>';
                    box += '<div class="d-flex flex-wrap">';
                        box += '<div class="col-12 col-sm-9">';
                            box += '<h5 class="mb-1 mt-0" style="color: #FFFFFF;">' + langDict['sessionTime'] + '：' + moment.unix(_this.date).format("YYYY 年 MM 月 DD 日 hh:mm") + '</h5>';
                            box += '<h5 class="mb-1 mt-0" style="color: #FFFFFF;">' + langDict['title'] + '：' + _this.title + '</h5>';
                            box += '<div class="d-flex flex-wrap mt-2">';
                                box += '<div class="col-12 col-sm-6">';
                                box += '<p><span class="badge badge-secondary">' + langDict['pos'] + '：</span></p>'
                                box += '</div>';
                                box += '<div class="col-12 col-sm-6">';
                                box += '<p><span class="badge badge-secondary">' + langDict['neg'] + '：</span></p>'
                                box += '</div>';
                            box += '</div>';
                        box += '</div>';
                        box += '<div class="col-12 col-sm-3">';
                            box += '<div class="d-flex justify-content-center align-items-end flex-column">';
                            box += '<button class="btn btn-light">' + langDict['downloadArticle'] + '</button>';
                            box += '<button class="btn btn-light">' + langDict['judgeFeedback'] + '</button>';
                            box += '<div>';
                        box += '</div>';
                    box += '</div>';
                    box += '</div>';
                    $('#pastEvent').append(box);
                }

            }
        }else
            $.growl.error({message: a.message})
    }); 

    
    $(document).on('click', '.start-btn', function () {
        const sid = $(this).data('id');
        location.href = "http://127.0.0.1:8000/candidate/" + mid + "/session/" + sid;
    });
 });