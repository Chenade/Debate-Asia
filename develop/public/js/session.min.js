$(document).ready(function() {
    const rid = window.location.pathname.split('/')[4];
    const cid = window.location.pathname.split('/')[2];
    var mid = 0, sid = 0, stage = 0, role = null, lastUpdated = null, 
    mainTimer = null, saveArticleTimer = null;

    var getTimeDiff = function(lastUpdated, duration)
    {
        const _time = moment().utc();
        var diff = _time.diff(moment(lastUpdated).utc(true), "seconds");
        duration = parseInt(duration) * 60;
        return (duration - diff);
    }, initSessionInfo = function(data)
    {
        const width = $('#size_default').width();
        for(const i in data.usr)
        {
            if (data.usr[i].mid == mid)
                role = i;
            if (data.usr[i].role == 1)
            {
                $('#a_name').text(data.usr[i].name_cn);
                $('#a_school').text(data.usr[i].school_cn);
                
            }
            else
            {
                $('#b_name').text(data.usr[i].name_cn);
                $('#b_school').text(data.usr[i].school_cn);
            }
        }
        console.log(role);
        if (role == 1)
        {
            $('#pos_box').empty();
            $('#neg_box').empty();
            $('#pos_box').append('<video id="user_camera" playsinline autoplay muted></video>');
            $('#neg_box').append('<img id="tmp" src="" style="padding:0;width:300px;height:225px;"/>');   
        }
        else
        {
            $('#pos_box').empty();
            $('#neg_box').empty();
            $('#neg_box').append('<video id="user_camera" playsinline autoplay muted></video>');
            $('#pos_box').append('<img id="tmp" src="" style="padding:0;width:300px;height:225px;"/>');
        }
        var video = document.getElementById('user_camera');
            video.style.width = $('#size_default').width();
            video.style.height = '225px';

            var facingMode = "user";
            var constraints = {
                audio: false,
                video: {
                    facingMode: facingMode
                }
            };

            navigator.mediaDevices.getUserMedia(constraints).then(function success(stream) {
                video.srcObject = stream;
            });

            setTimeout(() => {
                uploadImage();
            }, 1500);
    }, updateSession = function(stage)
    {
        var data = {
            'status': stage,
        };
        ajax('PUT', '/api/sessions/' + sid, data, function (a) {
            if(a.success){
                document.cookie = "Authorization="+a.token;
                if (stage == 4)
                {
                    $('.roles').css('display', 'inline');
                    $('#videos').attr('src', '');
                    $.growl.notice({message: '比賽結束!'});
                    setTimeout(() => {
                        window.location.href = "/candidate";
                    }, 3000);
                }
                else{
                    $.growl.notice({message: '已完成此階段，請靜候對手', duration: 10000})
                    setSessionStatus();
                }
            }else
                $.growl.error({message: a.message})
        }); 
    }, setSessionStatus = function()
    {
        ajax('GET', '/api/sessions/' + cid + '/rooms/' + rid + '/status', {}, function (a) {
            if(a.success){
                document.cookie = "Authorization=" + a.token;
                mid = a.data.mid;
                if (!role)
                    initSessionInfo(a.data);
                sid = a.data.usr[role].id;
                stage = a.data.usr[role].status;
                {
                    lastUpdated = (a.data.usr[0].updated_at > a.data.usr[1].updated_at) ? a.data.usr[0].updated_at : a.data.usr[1].updated_at;
                    switch (a.data.status)
                    {
                        case 0:
                            $('.roles').css('display', 'none');
                            $('#stage0').css('display', 'inline');
                            $('#stage1').css('display', 'none');
                            break;
                        case 1:
                            $('.roles').css('display', 'inline');
                            $('#stage0').css('display', 'none');
                            $('#stage1').css('display', 'inline');
                            $('#b_article_tab').css('display', 'none');
                            $('#a_article_tab').css('display', 'none');
                            $('#videos').attr('src', '');
                            $('#curStage').text('立論');
                            $('#tag').text(a.data.competition[0].tag);
                            $('#title').text(a.data.competition[0].title);
                            $('.t_write').text(a.data.competition[0].t_write);
                            $('.t_read').text(a.data.competition[0].t_read);
                            $('.t_debate').text(a.data.competition[0].t_debate);
                            
                            if (stage === a.data.status)
                            {
                                $('#moveStage').css('display', 'inline');
                                $('#moveStage').data('aid', a.data.usr[role].article.id);
                                $('#moveStage').data('stage', 2);
                                $('#remainTime').text(moment.utc(getTimeDiff(lastUpdated, a.data.competition[0].t_write)*1000).format('HH:mm:ss'));
                                $('#input').val(trimquotes(a.data.usr[role].article.content));
                                saveArticleTimer = setInterval(() => {
                                    saveArticle(a.data.usr[role].article.id);
                                }, 300000);
                                mainTimer = setInterval(() => { 
                                    $('#remainTime').text(moment.utc(getTimeDiff(lastUpdated, a.data.competition[0].t_write)*1000).format('HH:mm:ss'));
                                    if (getTimeDiff(lastUpdated, a.data.competition[0].t_write) <= 0)
                                    {
                                        clearInterval(mainTimer);
                                        clearInterval(saveArticleTimer);
                                        saveArticle(a.data.usr[role].article.id);
                                        if (stage == a.data.status)
                                            updateSession(2);
                                    }
                                }, 1000);
                            }
                        break;                               
                        case 2:
                            $('.roles').css('display', 'inline');
                            $('#stage0').css('display', 'none');
                            $('#stage1').css('display', 'inline');
                            $('#moveStage').css('display', 'none');
                            $('#videos').attr('src', '');
                            $('#curStage').text('閱讀');
                            $("#input").attr("disabled", "disabled"); 
                            $('#tag').text(a.data.competition[0].tag);
                            $('#title').text(a.data.competition[0].title);
                            $('.t_write').text(a.data.competition[0].t_write);
                            $('.t_read').text(a.data.competition[0].t_read);
                            $('.t_debate').text(a.data.competition[0].t_debate);
                            $('#b_article_tab').css('display', 'inline');
                            $('#_b_article_tab').click();
                            $('#b_article_content').val(trimquotes(a.data.usr[(role == 1) ? 0 : 1].article.content));

                            if (stage === a.data.status)
                            {
                                $('#remainTime').text(moment.utc(getTimeDiff(lastUpdated, a.data.competition[0].t_read)*1000).format('HH:mm:ss'));
                                if (getTimeDiff(lastUpdated, a.data.competition[0].t_read) <= 0)
                                {
                                    clearInterval(mainTimer);
                                    if (stage == a.data.status)
                                        updateSession(3);
                                }
                                $('#input').val(trimquotes(a.data.usr[role].article.content));
                                mainTimer = setInterval(() => {
                                    $('#remainTime').text(moment.utc(getTimeDiff(lastUpdated, a.data.competition[0].t_read)*1000).format('HH:mm:ss'));
                                    if (getTimeDiff(lastUpdated, a.data.competition[0].t_read) <= 0)
                                    {
                                        clearInterval(mainTimer);
                                        if (stage == a.data.status)
                                            updateSession(3);
                                    }
                                }, 1000);
                            }
                        break ;
                        case 3:
                            $('.roles').css('display', 'inline');
                            $('#stage0').css('display', 'none');
                            $('#stage1').css('display', 'inline');
                            $('#moveStage').css('display', 'inline');
                            $('#moveStage').data('aid', a.data.usr[role].article.id);
                            $('#moveStage').data('stage', 4);
                            $('#videos').attr('src', '');
                            $('#curStage').text('反駁');
                            $("#input").removeAttr("disabled"); 
                            $('#tag').text(a.data.competition[0].tag);
                            $('#title').text(a.data.competition[0].title);
                            $('.t_write').text(a.data.competition[0].t_write);
                            $('.t_read').text(a.data.competition[0].t_read);
                            $('.t_debate').text(a.data.competition[0].t_debate);
                            $('#b_article_tab').css('display', 'inline');
                            $('#a_article_tab').css('display', 'inline');
                            $('#_b_article_tab').click();
                            $('#b_article_content').val(trimquotes(a.data.usr[(role == 1) ? 0 : 1].article.content));
                            $('#a_article_content').val(trimquotes(a.data.usr[role].article.content));
                            
                            if (stage === a.data.status)
                            {
                                $('#remainTime').text(moment.utc(getTimeDiff(lastUpdated, a.data.competition[0].t_debate)*1000).format('HH:mm:ss'));
                                $('#input').val(trimquotes(a.data.usr[role].debate.content));
                                saveArticleTimer = setInterval(() => {
                                    saveArticle(a.data.usr[role].debate.id);
                                }, 300000);
                                mainTimer = setInterval(() => {
                                    $('#remainTime').text(moment.utc(getTimeDiff(lastUpdated, a.data.competition[0].t_debate)*1000).format('HH:mm:ss'));
                                    if (getTimeDiff(lastUpdated, a.data.competition[0].t_debate) <= 0)
                                    {
                                        clearInterval(mainTimer);
                                        clearInterval(saveArticleTimer);
                                        saveArticle(a.data.usr[role].debate.id);
                                        if (stage == a.data.status)
                                            updateSession(4);
                                    }
                                }, 1000);
                            }
                        break ;                      
                        case 4:
                            $('.roles').css('display', 'inline');
                            $('#videos').attr('src', '');
                            $.growl.notice({message: '比賽已結束!'});
                            setTimeout(() => {
                                window.location.href = "/candidate";
                            }, 3000);
                        break ;
                    }
                }
                if (stage != a.data.status)
                {
                    $.growl.warning({message: '請靜待'})
                    var t = setTimeout(() => {
                        setSessionStatus();
                    }, 10000);
                }
            }else
                $.growl.error({message: a.message})
        }); 
    }, saveArticle = function(id)
    {
        var data = {
            'content': $('#input').val(),
        };
        ajax('PUT', '/api/articles/' + id, data, function (a) {
            if(a.success){
                document.cookie = "Authorization="+a.token;
                $.growl.notice({message: '已儲存文稿'})
            }else
                $.growl.error({message: a.message})
        }); 
    }, uploadImage = function(){
        var video = document.getElementById('user_camera');
        var canvas = document.createElement('canvas');
            canvas.width = 640;
            canvas.height = 480;
            var ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            var dataURI = canvas.toDataURL('image/jpeg'); // can also use 'image/png'
        
        const data = {
            dataURI : dataURI,
            sid: sid
        }

        ajax('POST', '/api/image/session/' + sid + '/store', data, function (a) {
            if(a.success){
                document.cookie = "Authorization=" + a.token;
                $('#tmp').attr('src', a.content);
                setTimeout(() => {
                    uploadImage();
                }, 3000);
            }else
                $.growl.error({message: a.message})
        }); 
        return false;
    };

    setSessionStatus(rid);

    $(document).on('click', '.next-stage', function () {
        stage = $(this).data('stage');
        updateSession(stage);
    });

    
    $(document).on('click', '#moveStage', function () {
        const stage = $(this).data('stage');
        const aid = $(this).data('aid');
        clearInterval(saveArticleTimer);
        clearInterval(mainTimer);
        saveArticle(aid);
        updateSession(stage);
        $('#moveStage').css('display', 'none');
        $('#remainTime').text("00:00:00");
    });
 });