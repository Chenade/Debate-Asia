function updateUI(stage, data) {
    $('.roles').css('display', 'inline');
    $('#b_article_tab, #a_article_tab').css('display', 'none');
    $('#videos').attr('src', '');

    switch (stage) {
        case 0:
            $('#stage0').css('display', 'inline');
            $('.roles').css('display', 'none');
            $('#moveStage').data('stage', 1);
            break;
        case 1:
            displaySessionInfo(data);
            $('#curStage').text(langDict['argument']);
            $('#stage1').css('display', 'inline');
            $('#input').val(trimquotes(data.articles.content));
            $('#input').data('aid', data.articles.article_id);
            $('#moveStage').data('stage', 2);
            break;
        case 2:
            displaySessionInfo(data);
            $('#curStage').text(langDict['read']);
            $('#stage1').css('display', 'inline');
            $('#b_article_tab, #_b_article_tab').css('display', 'inline');
            $('#b_article_content').val(trimquotes(data.ops_argument.content)).prop('disabled', true);
            $('#input').val(trimquotes(data.articles.content));
            $('#input').data('aid', data.articles.article_id).prop('disabled', true);
            $('#saveArticle').css('display', 'none');
            $('#moveStage').data('stage', 3);
            break;
        case 3:
            displaySessionInfo(data);
            $('#curStage').text(langDict['rebuttal']);
            $('#stage1, #b_article_tab, #a_article_tab').css('display', 'inline');
            $('#b_article_content').val(trimquotes(data.ops_argument.content)).prop('disabled', true);
            $('#a_article_content').val(trimquotes(data.my_argument.content)).prop('disabled', true);
            $('#input').val(trimquotes(data.articles.content));
            $('#input').data('aid', data.articles.article_id).prop('disabled', false);
            $('#moveStage').data('stage', 4);
            break;
        case 4:
            displaySessionInfo(data);
            $('.roles, #videos').css('display', 'inline');
            showEndMessage();
            break;
    }
}

function displaySessionInfo(data) {
    $('#tag').text(data.session.session_name);
    $('#title').empty();
    $('#title').append('<h4 class="mt-0 mb-1" style="text-indent: 1em;">' + data.session.neg_title + '</h4>');
    $('#title').append('<h4 class="mt-0 mb-1" style="text-indent: 1em;">' + data.session.pos_title + '</h4>');
    $('.t_write').text(data.session.t_write);
    $('.t_read').text(data.session.t_read);
    $('.t_debate').text(data.session.t_debate);
}

function showEndMessage() {
    $.growl.notice({ message: '比賽已結束!' });
    setTimeout(() => {
        window.location.href = '/candidate';
    }, 3000);
}

$(document).ready(function() {
    const rid = window.location.pathname.split('/')[4];
    const cid = window.location.pathname.split('/')[2];
    var mid = 0, sid = 0, stage = 0, role = null, lastUpdated = null, 
    mainTimer = null, saveArticleTimer = null;
    const rounds_id = window.location.pathname.split('/')[3];

    var getTimeDiff = function(lastUpdated, duration)
    {
        const _time = moment().utc();
        var diff = _time.diff(moment(lastUpdated).utc(true), "seconds");
        duration = parseInt(duration) * 60;
        return (duration - diff);
    }, initSessionInfo = function(a)
    {
        for(const i in a.data.rounds)
            {
                let role = (a.data.rounds[i].role == 1) ? 'a' : 'b';
                $(`#${role}_name`).text(a.data.rounds[i].name_cn);
                $(`#${role}_school`).text(a.data.rounds[i].school_cn);
            }
            
            if (a.data.user.role == 1)
            {
                $('#pos_box').empty();
                $('#neg_box').empty();
                $('#pos_box').append('<video id="user_camera" playsinline autoplay muted></video>');
                $('#neg_box').append('<img id="tmp" src="" style="padding:0;width:300px;height:225px;"/>');   
            }
            else
            {
                $('#pos_box').empty();
                $('#neg_box').empty();
                $('#neg_box').append('<video id="user_camera" playsinline autoplay muted></video>');
                $('#pos_box').append('<img id="tmp" src="" style="padding:0;width:300px;height:225px;"/>');
            }
            var video = document.getElementById('user_camera');
                video.style.width = $('#size_default').width();
                video.style.height = '225px';

                var facingMode = "user";
                var constraints = {
                    audio: false,
                    video: {
                        facingMode: facingMode
                    }
                };

                navigator.mediaDevices.getUserMedia(constraints).then(function success(stream) {
                    video.srcObject = stream;
                });

                setTimeout(() => {
                    uploadImage();
                }, 1500);
    }, updateSession = function(stage)
    {
        var data = {
            'status': stage,
        };
        ajax('PUT', '/api/rounds/' + rounds_id, data, function (a) {
            if(a.success){
                document.cookie = "Authorization="+a.token+"; path=/";
                if (stage == 4)
                {
                    $('.roles').css('display', 'inline');
                    $('#videos').attr('src', '');
                    $.growl.notice({message: '比賽結束!'});
                    setTimeout(() => {
                        window.location.href = "/candidate";
                    }, 3000);
                }
                else{
                    $.growl.notice({message: '已完成此階段', duration: 10000})
                    setSessionStatus();
                }
            }else
                $.growl.error({message: a.message})
        }); 
    }, setSessionStatus = function()
    {
        ajax('GET', '/api/rounds/' + rounds_id, {}, function (a){
            if(a.success)
            {
                console.log(a); 
                initSessionInfo(a);
                let status = a.data.user.status;
                updateUI(status, a.data);
                
            }
        });
        // ajax('GET', '/api/sessions/' + cid + '/rooms/' + rid + '/status', {}, function (a) {
        //     if(a.success){
        //         // document.cookie = "Authorization=" + a.token+"; path=/";
        //         mid = a.data.mid;
        //         if (!role)
        //             initSessionInfo(a.data);
        //         sid = a.data.usr[role].id;
        //         stage = a.data.usr[role].status;
        //         {
        //             if (a.data.usr[0].status == a.data.usr[1].status)
        //                 lastUpdated = (a.data.usr[0].updated_at > a.data.usr[1].updated_at) ? a.data.usr[0].updated_at : a.data.usr[1].updated_at;
        //             else
        //                 lastUpdated = (a.data.usr[0].status < a.data.usr[1].status) ? a.data.usr[0].updated_at : a.data.usr[1].updated_at;
        //             switch (a.data.status)
        //             {
        //                 case 0:
        //                     $('.roles').css('display', 'none');
        //                     $('#stage0').css('display', 'inline');
        //                     $('#stage1').css('display', 'none');
        //                     break;
        //                         case 1:
        //                             $('.roles').css('display', 'inline');
        //                             $('#stage0').css('display', 'none');
        //                             $('#stage1').css('display', 'inline');
        //                             $('#b_article_tab').css('display', 'none');
        //                             $('#a_article_tab').css('display', 'none');
        //                             $('#videos').attr('src', '');
        //                             $('#curStage').text(langDict['argument']);
        //                             $('#tag').text(a.data.competition[0].tag);
        //                             $('#title').empty();
        //                             $('#title').append('<h4 class="mt-0 mb-1" style="text-indent: 1em;">' + translate(a.data.competition[0].title).split('$?')[0] + '</h4>');
        //                             $('#title').append('<h4 class="mt-0 mb-1" style="text-indent: 1em;">' + translate(a.data.competition[0].title).split('$?')[1] + '</h4>');
        //                             // $('#title').text(translate(a.data.competition[0].title));
        //                             $('.t_write').text(a.data.competition[0].t_write);
        //                             $('.t_read').text(a.data.competition[0].t_read);
        //                             $('.t_debate').text(a.data.competition[0].t_debate);
                                    
        //                     if (stage === a.data.status)
        //                     {
        //                         $('#moveStage').css('display', 'inline');
        //                         $('#moveStage').data('aid', a.data.usr[role].article.id);
        //                         $('#moveStage').data('stage', 2);
        //                         $('#remainTime').text(moment.utc(getTimeDiff(lastUpdated, a.data.competition[0].t_write)*1000).format('HH:mm:ss'));
        //                         $('#input').val(trimquotes(a.data.usr[role].article.content));
        //                         saveArticleTimer = setInterval(() => {
        //                             saveArticle(a.data.usr[role].article.id);
        //                         }, 300000);
        //                         clearInterval(mainTimer);
        //                         mainTimer = setInterval(() => {
        //                             $('#remainTime').text(moment.utc(getTimeDiff(lastUpdated, a.data.competition[0].t_write)*1000).format('HH:mm:ss'));
        //                             if (getTimeDiff(lastUpdated, a.data.competition[0].t_write) <= 0)
        //                             {
        //                                 clearInterval(mainTimer);
        //                                 clearInterval(saveArticleTimer);
        //                                 saveArticle(a.data.usr[role].article.id);
        //                                 if (stage == a.data.status)
        //                                     updateSession(2);
        //                             }
        //                         }, 1000);
        //                     }
        //                 break;                               
        //                 case 2:
        //                     $('.roles').css('display', 'inline');
        //                     $('#stage0').css('display', 'none');
        //                     $('#stage1').css('display', 'inline');
        //                     $('#moveStage').css('display', 'none');
        //                     $('#videos').attr('src', '');
        //                     $('#curStage').text(langDict['read']);
        //                     $("#input").attr("disabled", "disabled"); 
        //                     $('#tag').text(a.data.competition[0].tag);
        //                     $('#title').empty();
        //                     $('#title').append('<h4 class="mt-0 mb-1" style="text-indent: 1em;">' + translate(a.data.competition[0].title).split('$?')[0] + '</h4>');
        //                     $('#title').append('<h4 class="mt-0 mb-1" style="text-indent: 1em;">' + translate(a.data.competition[0].title).split('$?')[1] + '</h4>');
        //                     // $('#title').text(translate(a.data.competition[0].title));
        //                     $('.t_write').text(a.data.competition[0].t_write);
        //                     $('.t_read').text(a.data.competition[0].t_read);
        //                     $('.t_debate').text(a.data.competition[0].t_debate);
        //                     $('#b_article_tab').css('display', 'inline');
        //                     $('#_b_article_tab').click();
        //                     $('#b_article_content').val(trimquotes(a.data.usr[(role == 1) ? 0 : 1].article.content));

        //                     if (stage === a.data.status)
        //                     {
        //                         $('#remainTime').text(moment.utc(getTimeDiff(lastUpdated, a.data.competition[0].t_read)*1000).format('HH:mm:ss'));
        //                         if (getTimeDiff(lastUpdated, a.data.competition[0].t_read) <= 0)
        //                         {
        //                             clearInterval(mainTimer);
        //                             if (stage == a.data.status)
        //                                 updateSession(3);
        //                         }
        //                         $('#input').val(trimquotes(a.data.usr[role].article.content));
        //                         clearInterval(mainTimer);
        //                         mainTimer = setInterval(() => {
        //                             $('#remainTime').text(moment.utc(getTimeDiff(lastUpdated, a.data.competition[0].t_read)*1000).format('HH:mm:ss'));
        //                             if (getTimeDiff(lastUpdated, a.data.competition[0].t_read) <= 0)
        //                             {
        //                                 clearInterval(mainTimer);
        //                                 if (stage == a.data.status)
        //                                     updateSession(3);
        //                             }
        //                         }, 1000);
        //                     }
        //                 break ;
        //                 case 3:
        //                     $('.roles').css('display', 'inline');
        //                     $('#stage0').css('display', 'none');
        //                     $('#stage1').css('display', 'inline');
        //                     $('#moveStage').css('display', 'inline');
        //                     $('#moveStage').data('aid', a.data.usr[role].article.id);
        //                     $('#moveStage').data('stage', 4);
        //                     $('#videos').attr('src', '');
        //                     $('#curStage').text(langDict['rebuttal']);
        //                     $("#input").removeAttr("disabled"); 
        //                     $('#tag').text(a.data.competition[0].tag);
        //                     $('#title').empty();
        //                     $('#title').append('<h4 class="mt-0 mb-1" style="text-indent: 1em;">' + translate(a.data.competition[0].title).split('$?')[0] + '</h4>');
        //                     $('#title').append('<h4 class="mt-0 mb-1" style="text-indent: 1em;">' + translate(a.data.competition[0].title).split('$?')[1] + '</h4>');
        //                     // $('#title').text(translate(a.data.competition[0].title));
        //                     $('.t_write').text(a.data.competition[0].t_write);
        //                     $('.t_read').text(a.data.competition[0].t_read);
        //                     $('.t_debate').text(a.data.competition[0].t_debate);
        //                     $('#b_article_tab').css('display', 'inline');
        //                     $('#a_article_tab').css('display', 'inline');
        //                     $('#_b_article_tab').click();
        //                     $('#b_article_content').val(trimquotes(a.data.usr[(role == 1) ? 0 : 1].article.content));
        //                     $('#a_article_content').val(trimquotes(a.data.usr[role].article.content));
                            
        //                     if (stage === a.data.status)
        //                     {
        //                         $('#remainTime').text(moment.utc(getTimeDiff(lastUpdated, a.data.competition[0].t_debate)*1000).format('HH:mm:ss'));
        //                         $('#input').val(trimquotes(a.data.usr[role].debate.content));
        //                         saveArticleTimer = setInterval(() => {
        //                             saveArticle(a.data.usr[role].debate.id);
        //                         }, 300000);
        //                         clearInterval(mainTimer);
        //                         mainTimer = setInterval(() => {
        //                             $('#remainTime').text(moment.utc(getTimeDiff(lastUpdated, a.data.competition[0].t_debate)*1000).format('HH:mm:ss'));
        //                             if (getTimeDiff(lastUpdated, a.data.competition[0].t_debate) <= 0)
        //                             {
        //                                 clearInterval(mainTimer);
        //                                 clearInterval(saveArticleTimer);
        //                                 saveArticle(a.data.usr[role].debate.id);
        //                                 if (stage == a.data.status)
        //                                     updateSession(4);
        //                             }
        //                         }, 1000);
        //                     }
        //                 break ;                      
        //                 case 4:
        //                     $('.roles').css('display', 'inline');
        //                     $('#videos').attr('src', '');
        //                     $.growl.notice({message: '比賽已結束!'});
        //                     setTimeout(() => {
        //                         window.location.href = "/candidate";
        //                     }, 3000);
        //                 break ;
        //             }
        //         }
        //         if (stage != a.data.status)
        //         {
        //             $.growl.warning({message: '請靜待'})
        //             var t = setTimeout(() => {
        //                 setSessionStatus();
        //             }, 10000);
        //         }
        //     }else
        //         $.growl.error({message: a.message})
        // }); 
    }, saveArticle = function(id)
    {
        var data = {
            'content': $('#input').val(),
        };
        ajax('PUT', '/api/articles/' + id, data, function (a) {
            if(a.success){
                // document.cookie = "Authorization="+a.token+"; path=/";
                $.growl.notice({message: '已儲存文稿'})
            }else
                $.growl.error({message: a.message})
        }); 
    }, uploadImage = function(){
        var video = document.getElementById('user_camera');
        var canvas = document.createElement('canvas');
            canvas.width = 640;
            canvas.height = 480;
            var ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            var dataURI = '';
            dataURI = canvas.toDataURL('image/jpeg'); // can also use 'image/png'
        
        const data = {
            dataURI : dataURI,
            round_id: rounds_id
        }

        ajax('POST', '/api/rounds/' + rounds_id + '/image', data, function (a) {
            if(a.success){
                // document.cookie = "Authorization=" + a.token+"; path=/";
                $('#tmp').attr('src', '/camera/' + a.data);
                setTimeout(() => {
                    uploadImage();
                }, 3000);
            }else
                $.growl.error({message: a.message})
        }); 
        return false;
    };

    setSessionStatus();

    $(document).on('click', '.next-stage', function () {
        stage = $(this).data('stage');
        updateSession(stage);
    });

    $(document).on('click', '#saveArticle', function () {
        const aid = $('#input').data('aid');
        saveArticle(aid);
    });
    
    $(document).on('click', '#moveStage', function () {
        $('#saveArticle').click();
        const stage = $(this).data('stage');
        console.log(stage);
        updateSession(stage);
        // $('#moveStage').css('display', 'none');
        // $('#remainTime').text("00:00:00");
    });
 });