$(document).ready(function() {
    $('body').css('overflow', 'hidden');

    // const mid = window.location.pathname.split('/')[2];
    const rid = window.location.pathname.split('/')[3];
    var mid = 0, sid = 0, stage = 0, role = null, lastUpdated = null, 
    mainTimer = null, saveArticleTimer = null;

    var trimquotes = function(str)
    {
        if (str === 'null')
            return ""
        if (str)
        {
            str = str.replaceAll('\n', '<br/>');
            return (str.substring(1, str.length-1));
        }
        return ""
        
    }, initSessionInfo = function(data)
    {
        for(const i in data.usr)
        {
            if (data.usr[i].mid == mid)
                role = i;
            if (data.usr[i].role == 1)
            {
                $('#a_name').text(data.usr[i].name_cn);
                $('#a_school').text(data.usr[i].school_cn);
            }
            else
            {
                $('#b_name').text(data.usr[i].name_cn);
                $('#b_school').text(data.usr[i].school_cn);
            }
        }
    }, updateSession = function(stage)
    {
        var data = {
            'status': stage,
        };
        ajax('PUT', '/api/sessions/' + sid, data, function (a) {
            if(a.success){
                document.cookie = "Authorization="+a.token;
                if (stage == 4)
                {
                    $('.roles').css('display', 'inline');
                    $('#videos').attr('src', '');
                    $.growl.notice({message: '比賽結束!'});
                    setTimeout(() => {
                        window.location.href = "/candidate";
                    }, 3000);
                }
                else{
                    $.growl.notice({message: '已完成此階段，請靜候對手', duration: 5000})
                    setSessionStatus();
                }
            }else
                $.growl.error({message: a.message})
        }); 
    }, setSessionStatus = function()
    {
        ajax('GET', '/api/sessions/rooms/' + rid + '/status', {}, function (a) {
            if(a.success){
                document.cookie = "Authorization=" + a.token;
                mid = a.data.mid;
                if (!role)
                    initSessionInfo(a.data);
                sid = a.data.usr[role].id;
                stage = a.data.usr[role].status;
                {
                    var _now, diff;
                    lastUpdated = (a.data.usr[0].updated_at > a.data.usr[1].updated_at) ? a.data.usr[0].updated_at : a.data.usr[1].updated_at;
                    switch (a.data.status) {
                        case 0:
                            $('.roles').css('display', 'none');
                            $('#stage0').css('display', 'inline');
                            $('#stage1').css('display', 'none');
                            break;
                        case 1:
                            $('.roles').css('display', 'inline');
                            $('#stage0').css('display', 'none');
                            $('#stage1').css('display', 'inline');
                            $('#b_article_tab').css('display', 'none');
                            $('#a_article_tab').css('display', 'none');
                            $('#videos').attr('src', '');
                            $('#curStage').text('立論');
                            $('#tag').text(a.data.competition[0].tag);
                            $('#title').text(a.data.competition[0].title);
                            $('.t_write').text(a.data.competition[0].t_write);
                            $('.t_read').text(a.data.competition[0].t_read);
                            $('.t_debate').text(a.data.competition[0].t_debate);
                            
                            if (stage === a.data.status)
                            {
                                _now = moment(new Date());
                                diff = (moment(_now).diff(lastUpdated, 'minutes'))- 59;
                                $('#remainTime').text(a.data.competition[0].t_write - diff);
                                $('#input').val(trimquotes(a.data.usr[role].article.content));
                                saveArticleTimer = setInterval(() => {
                                    saveArticle(a.data.usr[role].article.id);
                                }, 300000);
                                mainTimer = setInterval(() => { 
                                    const _now = moment(new Date());
                                    const diff = (moment(_now).diff(lastUpdated, 'minutes'))- 59;
                                    $('#remainTime').text(a.data.competition[0].t_write - diff);
                                    if (diff >= a.data.competition[0].t_write)
                                    {
                                        clearInterval(mainTimer);
                                        clearInterval(saveArticleTimer);
                                        saveArticle(a.data.usr[role].article.id);
                                        if (stage == a.data.status)
                                        updateSession(2);
                                    }
                                }, 60000);
                            }
                            break;
                                
                        case 2:
                            $('.roles').css('display', 'inline');
                            $('#stage0').css('display', 'none');
                            $('#stage1').css('display', 'inline');
                            $('#videos').attr('src', '');
                            $('#curStage').text('閱讀');
                            $('#tag').text(a.data.competition[0].tag);
                            $('#title').text(a.data.competition[0].title);
                            $('.t_write').text(a.data.competition[0].t_write);
                            $('.t_read').text(a.data.competition[0].t_read);
                            $('.t_debate').text(a.data.competition[0].t_debate);
                            $('#b_article_tab').css('display', 'inline');
                            $('#_b_article_tab').click();
                            $('#b_article_content').val(trimquotes(a.data.usr[(role == 1) ? 0 : 1].article.content));

                            if (stage === a.data.status)
                            {
                                _now = moment(new Date());
                                diff = (moment(_now).diff(lastUpdated, 'minutes'))- 59;
                                $('#remainTime').text(a.data.competition[0].t_read - diff);
                                if (diff > a.data.competition[0].t_read)
                                {
                                    clearInterval(mainTimer);
                                    if (stage == a.data.status)
                                        updateSession(3);
                                }
                                $('#input').val(trimquotes(a.data.usr[role].article.content));
                                mainTimer = setInterval(() => {
                                    const _now = moment(new Date());
                                    const diff = (moment(_now).diff(lastUpdated, 'minutes'))- 59;
                                    $('#remainTime').text(a.data.competition[0].t_read - diff);
                                    if (diff > a.data.competition[0].t_read)
                                    {
                                        clearInterval(mainTimer);
                                        if (stage == a.data.status)
                                            updateSession(3);
                                    }
                                }, 60000);
                            }
                            break ;

                        case 3:
                            $('.roles').css('display', 'inline');
                            $('#stage0').css('display', 'none');
                            $('#stage1').css('display', 'inline');
                            $('#videos').attr('src', '');
                            $('#curStage').text('反駁');
                            $('#tag').text(a.data.competition[0].tag);
                            $('#title').text(a.data.competition[0].title);
                            $('.t_write').text(a.data.competition[0].t_write);
                            $('.t_read').text(a.data.competition[0].t_read);
                            $('.t_debate').text(a.data.competition[0].t_debate);
                            $('#b_article_tab').css('display', 'inline');
                            $('#a_article_tab').css('display', 'inline');
                            $('#_b_article_tab').click();
                            $('#b_article_content').val(trimquotes(a.data.usr[(role == 1) ? 0 : 1].article.content));
                            $('#a_article_content').val(trimquotes(a.data.usr[role].article.content));
                            
                            if (stage === a.data.status)
                            {
                                _now = moment(new Date());
                                diff = (moment(_now).diff(lastUpdated, 'minutes'))- 59;
                                $('#remainTime').text(a.data.competition[0].t_debate - diff);
                                $('#input').val(trimquotes(a.data.usr[role].debate.content));
                                saveArticleTimer = setInterval(() => {
                                    saveArticle(a.data.usr[role].debate.id);
                                }, 300000);
                                mainTimer = setInterval(() => {
                                    const _now = moment(new Date());
                                    const diff = (moment(_now).diff(lastUpdated, 'minutes'))- 59;
                                    $('#remainTime').text(a.data.competition[0].t_debate  - diff);
                                    if (diff > a.data.competition[0].t_debate)
                                    {
                                        clearInterval(mainTimer);
                                        clearInterval(saveArticleTimer);
                                        saveArticle(a.data.usr[role].debate.id);
                                        if (stage == a.data.status)
                                            updateSession(4);
                                    }
                                }, 60000);
                            }
                            break ;
                        
                        case 4:
                            $('.roles').css('display', 'inline');
                            $('#videos').attr('src', '');
                            $.growl.notice({message: '比賽已結束!'});
                            setTimeout(() => {
                                window.location.href = "/candidate";
                            }, 3000);
                    }
                }
                if (stage != a.data.status)
                {
                    $.growl.warning({message: '請靜待'})
                    var t = setTimeout(() => {
                        setSessionStatus();
                    }, 10000);
                }
            }else
                $.growl.error({message: a.message})
        }); 
    }, saveArticle = function(id)
    {
        var data = {
            'content': $('#input').val(),
        };
        ajax('PUT', '/api/articles/' + id, data, function (a) {
            if(a.success){
                document.cookie = "Authorization="+a.token;
                $.growl.notice({message: '已儲存文稿'})
            }else
                $.growl.error({message: a.message})
        }); 
    };

    setSessionStatus(rid);

    $(document).on('click', '.next-stage', function () {
        const _sid = $(this).data('id');
        stage = $(this).data('stage');
        updateSession(stage);
    });
 });