$(document).ready(function(){

    var awards = '';

    var convertStatus = function(status){
        switch (status) {
            case 0:
                return "未開始";
            case 1:
                return "立論環節";
            case 2:
                return "閱讀環節";
            case 3:
                return "駁論環節";
            case 4:
                return "比賽結束";
            case 5:
                return "評分結束";
            case 6:
                return "排名結束";
            default:
                break;
        }
    }, getCompetition = function(){
        ajax('GET', '/api/admin/competition/list', {}, function (a) {
            if(a.success){
                $('#clist').empty();
                for (const i in a.data)
                {
                    const _this = a.data[i];
                    var box = '<div class="ml-2">\
                                <input type="checkbox" class="competition" name="cid_+' + _this.id + '" id="cid_+' + _this.id + '" data-id="' + _this.id + '"">\
                                <label for="cid_+' + _this.id + '">' + _this.tag + '</label>\
                            </div>';
                    $('#clist').append(box);
                }
            }else
                $.growl.error({message: a.message})
        });
    }, getAwardList = function(){
        ajax('GET', '/api/awards/list', {}, function (a) {
            console.log(a);
            $('#awardlist').empty();
            awards = '<option value="0">未得名</option>';
            for (const i in a.data)
            {
                const _this = a.data[i];
                $('#awardlist').append('<li>' + _this.name + '</li>');
                awards += '<option value="'+ _this.id +'">' + _this.name + '</option>';
            }
        });
    };

    getCompetition();
    getAwardList();

    $(document).on('click', '#submit_award', function () {
        var data = {
            name: $('#award_name').val()
        };
        ajax('POST', '/api/awards/create', data, function (a) {
            if(a.success){
                $.growl.notice({message: '儲存成功'});
                getAwardList();
            }else
                $.growl.error({message: a.message})
        }); 
    });

    $(document).on('click', '.article-btn', function () {
        const asid = $(this).data('maid');
        const bsid = $(this).data('mbid');
        ajax('GET', '/api/admin/articles/list/' + asid + '/' + bsid, {}, function (a) {
            if(a.success){
                document.cookie = "Authorization="+a.token+"; path=/";
                object.article = a.data;
                if (a.data.a[0].content) $('#a_1').val(trimquotes(a.data.a[0].content));
                if (a.data.a[1].content) $('#a_2').val(trimquotes(a.data.a[1].content));
                if (a.data.b[0].content) $('#b_1').val(trimquotes(a.data.b[0].content));
                if (a.data.b[1].content) $('#b_2').val(trimquotes(a.data.b[1].content));
                $('#a_camera').attr('src', '/camera/' + a.data.candidates.a.camera);
                $('#b_camera').attr('src', '/camera/' + a.data.candidates.b.camera);
                $('#a_name').html(a.data.candidates.a.user.name_cn);
                $('#a_school').html(a.data.candidates.a.user.school_cn);
                $('#a_status').html(a.data.candidates.a['status']);
                $('#a_updated_at').html(a.data.candidates.a['updated_at']);
                $('#b_name').html(a.data.candidates.b.user.name_cn);
                $('#b_school').html(a.data.candidates.b.user.school_cn);
                $('#b_status').html(a.data.candidates.b['status']);
                $('#b_updated_at').html(a.data.candidates.b['updated_at']);
            }else
                $.growl.error({message: a.message})
        }); 

        $('#article_modal').modal({
            backdrop: 'static',
            keyboard: true,
            show: true
        });
    });

    $(document).on('click', '#submit_ranking', function () {
        var data = {
            lst: {}
        };
        $( ".award" ).each(function( index ) {
            data.lst[$(this).data('sid')] = $(this).val();
        });
        ajax('POST', '/api/ranking/submit', data, function (a) {
            if(a.success){
                $.growl.notice({message: '儲存成功'})
            }else
                $.growl.error({message: a.message})
        }); 
    });

    $(document).on('change', '.competition', function () {
        var data = {
            cid: []
        };
        $( ".competition" ).each(function( index ) {
            if ($(this).is(':checked'))
                data.cid.push($(this).data('id'));
        });
        ajax('POST', '/api/ranking/candidates/list', data, function (a) {
            if(a.success){
                $('#candidate_list').empty();
                for (const i in a.data)
                {
                    const _this = a.data[i];
                    var box = '';
                        box += '<tr>';
                        box += '<td class="col-3">' + _this.tag + '</td>';
                        box += '<td class="col-3">' + _this.name_cn + '</td>';
                        box += '<td class="col-3">' + _this.score + '</td>';
                        box += '<td class="col-3">';
                            box += '<select class="award" data-id="' + i + '" data-sid="' + _this.id + '">';
                            box += awards;
                            box += '</select>';
                        box += '</td>';
                        box += '</tr>';
                    $('#candidate_list').append(box);
                    $('.award[data-id="' + i +'"]').val(_this.rank);
                }
                if ($('.award[data-id="0"]').val() == 0) $('.award[data-id="0"]').val(1);
                if ($('.award[data-id="1"]').val() == 0) $('.award[data-id="1"]').val(2);
                if ($('.award[data-id="2"]').val() == 0) $('.award[data-id="2"]').val(3);
            }else
                $.growl.error({message: a.message})
        }); 
    });


});
