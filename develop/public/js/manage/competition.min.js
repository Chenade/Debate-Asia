//const { get } = require("lodash");

$(document).ready(function () {
    
    var tid = "competitions";

    var object = {};

    function getCompetition()
    {
        ajax('GET', '/api/' + tid, {}, function (a) {
            console.log(a);
            $("#competition_lst").empty();
            for (const i in a.data)
            {
                $('#competition_lst').append(`
                    <div class="col-12 competition-item" data-id="${a.data[i].id}"
                            style="border: solid #bbb 1px; padding: 10px;">
                            <h4 style="font-weight: 700; margin: 0">${a.data[i].competition_name}</h4>
                            <span>開始時間：${a.data[i].start_date}</span><br>
                            <span>結束時間：${a.data[i].end_date}</span>
                    </div>
                `);
            }
        });
    }

    function getCompetitionItem(competitionId)
    {
        ajax('GET', '/api/' + tid + '/' + competitionId, {}, function (a) {
            if (!a.error)
            {
                $('#competition_id').val(a.data.id);
                $('#edit_competition_name').val(a.data.competition_name);
                $('#edit_competition_start').val(a.data.start_date);
                $('#edit_competition_end').val(a.data.end_date);

                $('.nav-details').show();
                $('#group_lst').empty();
                $('#select_group_name').empty();
                for (const i in a.groups)
                {
                    $('#group_lst').append(`
                        <tr>
                            <td><input type="text" class="form-control edit_group_name" data-id="${a.groups[i].id}" value="${a.groups[i].group_name}"></td>
                            <td><input type="number" class="form-control t_write" data-id="${a.groups[i].id}" value="${a.groups[i].t_write}"></td>
                            <td><input type="number" class="form-control t_read" data-id="${a.groups[i].id}" value="${a.groups[i].t_read}"></td>
                            <td><input type="number" class="form-control t_debate" data-id="${a.groups[i].id}" value="${a.groups[i].t_debate}"></td>
                            <td><button class="btn btn-success group-save-btn" data-id="${a.groups[i].id}">SAVE</button></td>
                        </tr>
                    `);
                    $('#select_group_name').append(`
                        <option value="${a.groups[i].id}">${a.groups[i].group_name}</option>
                    `);
                }
                var newAjaxUrl = '/api/users/signup/list?competition_id=' + a.data.id + '&token=' + getCookie('Authorization');
                table.ajax.url(newAjaxUrl).load();
                $('#select_group_name').selectpicker('refresh');
                if (a.groups.length > 0)
                    getSessionLst(a.groups[0].id);
            }
        });
    };

    var table = $('#signupTable').DataTable({
        responsive: true,
        searching: true,
        ajax: {
            'url': '/api/users/signup/list?competition_id=1',
            'type': 'GET',
            'beforeSend': function (request) {
                request.setRequestHeader("token", getCookie('Authorization'));
            },
            error: function (xhr, error, thrown) {
                // $.growl.error({message: '連線逾時，請重新登入'});
                // setTimeout(() => {
                //     window.location.href = '/';
                // }, 1500);
            },
        },
        width: '100%',
        columns: [
            { data: 'group_name' },
            { data: 'name_cn' },
            { data: 'school_cn' },
            {
                data: 'approval',
                render: function (data, type, row) {
                    if (type === 'display') {
                        return '<input type="checkbox" ' + (data === 1 ? 'checked' : '') + ' disabled>';
                    }
                    return data;
                }
            },
            {
                data: 'id',
                render: function (data, type, row) {
                    if (type === 'display') {
                        return '<button class="btn btn-sm btn-secondary view-btn" data-id="' + data + '">View</button>';
                    }
                    return data;
                }
            }
        ],
        "drawCallback": function (settings) {
            table.responsive.recalc();
        },
        order: [[3, 'asc']]
    });

    $('.datetimepicker').flatpickr({
        altInput: true,
        dateFormat: "Y-m-d",
        enableTime: true,
        dateFormat: "Y-m-d H:i",
        defaultDate: new Date(),
    });

    getCompetition();

    $(document).on('click', '.competition-item', function () {
        var competitionId = $(this).data('id');
        getCompetitionItem(competitionId);
    });

    $('.competition-add-btn').click(function () {
        $('#competition_id').val('');
        $('#edit_competition_name').val('');
        $('#edit_competition_start').val('');
        $('#edit_competition_end').val('');
        $('.nav-details').hide();
    });

    $('.competition-save-btn').click(function () {

        var competitionId = $('#competition_id').val();

        var data = {
            id : $('#competition_id').val(),
            competition_name: $('#edit_competition_name').val(),
            start_date: $('#edit_competition_start').val(),
            end_date: $('#edit_competition_end').val(),
        };
        const _method = (competitionId === '') ? 'POST' : 'PUT';
        const _url = (competitionId === '') ? '/api/competitions' : '/api/competitions/' + competitionId;
        
        $.ajax({
            url: _url,
            method: _method,
            data: data,
            success: function (response) {
                getCompetition();
                getCompetitionItem(response.data.id);
            },
            error: function (xhr, status, error) {
                console.error(error);
            },
        });

    });

    $('.competition-delete-btn').click(function () {
        // Get competition ID from the button's data attribute
        var competitionId = $(this).data('id');

        // Perform an AJAX request to delete competition by ID
        $.ajax({
            url: '/api/competitions/' + competitionId, // Update the API endpoint to match your route
            method: 'DELETE',
            success: function (response) {
                // Handle the success response, e.g., refresh the DataTable
                $('#competitionTable').DataTable().ajax.reload();
                $('#competition_modal').modal('hide');
            },
            error: function (xhr, status, error) {
                // Handle the error, e.g., show an error message
                console.error(error);
            },
        });
    });

    $('.group-add-btn').click(function () {
        const competitionId = $('#competition_id').val();
        var data = {
            group_name: $('#add_group_name').val(),
            competition_id: competitionId
        };

        $.ajax({
            url: '/api/groups',
            method: 'POST',
            data: data,
            success: function (response) {
                getCompetitionItem(competitionId);
                // console.log(response);
                // $('#groupTable').DataTable().ajax.reload();
                // $('#group_modal').modal('hide');
            },
            error: function (xhr, status, error) {
                console.error(error);
            },
        });
    });

    $(document).on('click', '.group-save-btn', function () {
        var groupId = $(this).data('id');
        var data = {
            group_name: $('.edit_group_name[data-id="' + groupId + '"]').val(),
            t_write: $('.t_write[data-id="' + groupId + '"]').val(),
            t_read: $('.t_read[data-id="' + groupId + '"]').val(),
            t_debate: $('.t_debate[data-id="' + groupId + '"]').val(),
        };
        ajax('PUT', '/api/groups/' + groupId, data, function (a) {
            if (!a.error)
                $.growl.notice({ message: '更新成功' });
        });
    });

    $(document).on('click', '.view-btn', function () {
        var logId = $(this).data('id');
        $.ajax({
            url: '/api/users/signup/' + logId,
            method: 'GET',
            success: function (a) {
                $('#competition_modal').modal('show');
                $('.approval-btn').data('id', logId);

                $('#edit_account').html(a.data.account);
                $('#edit_email').html(a.data.email);
                $('#edit_chinese_name').html(a.data.name_cn);
                $('#edit_english_name').html(a.data.name_en);
                $('#edit_gender').val(a.data.gender);
                $('#edit_gender').selectpicker('refresh');
                $('#edit_birthday').val(moment.unix(a.data.birthday).format("YYYY-MM-DD"));
                $('#edit_cellphone').html(a.data.cellphone);
                $('#edit_wechat').html(a.data.wechat);
                $('#edit_address').html(a.data.address);
                $('#edit_region').html(a.data.region);
                $('#edit_school').html(a.data.school_cn);
                $('#edit_mentor').html(a.data.mentor);

                $('#edit_group').html(a.data.group_name);
                $('#edit_date').html(a.data.date).toString();
                $('#edit_language').html(a.data.language);
                $('#edit_input').html(a.data.language);
                
                $('#edit_invoice_name').html(a.data.invoice_name);
                $('#edit_invoice_no').html(a.data.invoice_no);

                $('.selectpicker').selectpicker('refresh');
                
                if (a.data.proof === 'none')
                {
                    $('#competition_img').hide();
                    $('#edit_noproof').prop('checked', true);
                }
                else
                {
                    $('#competition_img').attr('src', '/upload/Image/proof/' + a.data.proof);
                    $('#competition_img').show();
                    $('#edit_noproof').prop('checked', false);
                }

                if (a.data.approval === 1)
                    $('.approval-btn').hide();
                else
                    $('.approval-btn').show();
            },
            error: function (xhr, status, error) {
                console.error(error);
            }
        });
    });

    $(document).on('click', '.approval-btn', function () {
        var logId = $(this).data('id');
        $.ajax({
            url: '/api/users/signup/' + logId + '/approval',
            method: 'POST',
            data: {},
            success: function (response) {
                $('#competition_modal').modal('hide');
                table.ajax.reload();
            },
            error: function (xhr, status, error) {
                console.error(error);
            }
        });
    });

    function getSessionLst(groupId)
    {
        ajax('GET', '/api/groups/' + groupId + '/sessions', {}, function (a) {
            $('#session_lst').empty();
            for (const i in a.data)
            {
                $('#session_lst').append(`
                    <tr>
                        <td>${a.data[i].session_name}</td>
                        <td>${moment.unix(a.data[i].date).format('YYYY-MM-DD HH:mm:ss')}</td>
                        <td><button class="btn btn-sm btn-secondary session-edit-btn" data-id="${a.data[i].id}">EDIT</button></td>
                    </tr>
                `);
            }
        });
    }

    function getSessionInfo(sessionId)
    {
        ajax('GET', '/api/sessions/' + sessionId, {}, function (a) {
            $('#session_id').val(a.data.id);
            $('#edit_session_name').val(a.data.session_name);
            $('#edit_session_datetime').val(moment.unix(a.data.date).format('YYYY-MM-DD HH:mm:ss'));
            $('#edit_pos_title').val(a.data.pos_title);
            $('#edit_neg_title').val(a.data.neg_title);

            $('#select_user_name').empty();
            $('#candidate_lst').empty();
            for (const i in a.candidates)
            {
                // if (a.candidates[i].approval === 1)
                {
                    let option = (a.candidates[i].rounds.length > 0) ? 'disabled' : '';
                    $('#select_user_name').append(`
                        <option 
                            data-subtext="${(a.candidates[i].date).toString()}" 
                            value="${a.candidates[i].userId}"
                            ${option} >
                            ${a.candidates[i].name_cn}（${a.candidates[i].school_cn}）
                        </option>
                    `);
                }
                if (a.candidates[i].rounds.length > 0)
                {
                    const _this = a.candidates[i];
                    console.log(_this);
                    $('#candidate_lst').append(`
                        <tr>
                            <td>${_this.name_cn}</td>
                            <td>${_this.school_cn}</td>
                            <td>
                                <input 
                                    type="number" 
                                    class="form-control rounds-room-number" 
                                    data-id="${_this.rounds[0].id}"
                                    value="${((_this.rounds[0].round_number) != null) ? _this.rounds[0].round_number : ''}">
                            </td>
                            <td>
                                <select class="form-control rounds-role" data-id="${_this.rounds[0].id}">
                                    <option value="0" ${_this.rounds[0].role === null ? 'selected' : ''}>未指定</option>
                                    <option value="1" ${_this.rounds[0].role === 1 ? 'selected' : ''}>正方</option>
                                    <option value="2" ${_this.rounds[0].role === 2 ? 'selected' : ''}>反方</option>
                                </select>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-danger rounds-remove-btn" data-id="${_this.rounds[0].id}">REMOVE</button>
                            </td>
                        </tr>
                    `);
                }
            }
            $('#select_user_name').selectpicker('refresh');

            getRoundLst(a.data.id);

            $('#session_modal').modal({
                backdrop: 'static',
                keyboard: true
            });
        });
    }

    $('#select_group_name').change(function () {
        var groupId = $(this).val();
        getSessionLst(groupId);
    });

    $('#add-session-btn').click(function () {
        var groupId = $('#select_group_name').val();
        var data = {
            session_name: $('#add_session_name').val(),
            group_id: groupId,
            date: moment($('#add_session_datetime').val()).unix(),
        };
        ajax('POST', '/api/sessions', data, function (a) {
            getSessionLst(groupId);
        });
    });

    $('.session-save-btn').click(function () {
        var data = {
            session_name: $('#edit_session_name').val(),
            date: moment($('#edit_session_datetime').val()).unix(),
            pos_title: $('#edit_pos_title').val(),
            neg_title: $('#edit_neg_title').val(),
        };
        ajax('PUT', '/api/sessions/' + $('#session_id').val(), data, function (a) {
            if (!a.error)
            {
                $.growl.notice({ message: '更新成功' });
                getSessionLst($('#select_group_name').val());
            }
        });
    });

    $(document).on('click', '.session-edit-btn', function () {
        var sessionId = $(this).data('id');
        getSessionInfo(sessionId);
    });

    $(document).on('click', '.round-add-btn', function () {
        var userId = $('#select_user_name').val();
        var data = {
            session_id: $('#session_id').val(),
            user_id: userId,
            role: 0,
        };
        ajax('POST', '/api/rounds', data, function (a) {
            getSessionInfo($('#session_id').val());
        });
    });

    $(document).on('click', '.rounds-remove-btn', function () {
        var roundId = $(this).data('id');
        ajax('DELETE', '/api/rounds/' + roundId, {}, function (a) {
            getSessionInfo($('#session_id').val());
        });
    });

    $(document).on('change', '.rounds-room-number', function () {
        var roundId = $(this).data('id');
        var data = {
            round_number: $(this).val(),
        };
        ajax('PUT', '/api/rounds/' + roundId, data, function (a) {
            if (!a.error)
            {
                $.growl.notice({ message: '更新成功' });
                getSessionInfo($('#session_id').val());
            }
        });
    });

    $(document).on('change', '.rounds-role', function () {
        var roundId = $(this).data('id');
        var data = {
            role: $(this).val(),
        };
        ajax('PUT', '/api/rounds/' + roundId, data, function (a) {
            if (!a.error)
            {
                $.growl.notice({ message: '更新成功' });
                getSessionInfo($('#session_id').val());
            }
        });
    });

    $('#shuffle-round-btn').click(function () {
        var sessionId = $('#session_id').val();
        ajax('POST', '/api/sessions/' + sessionId + '/shuffle', {}, function (a) {
            getSessionLst($('#select_group_name').val());
            getSessionInfo(sessionId);
        });
    });

    $('#end-rounds-btn').click(function () {
        var sessionId = $('#session_id').val();
        ajax('POST', '/api/sessions/' + sessionId + '/end', {}, function (a) {
            getSessionLst($('#select_group_name').val());
        });
    });

    function getRoundLst(session_id)
    {
        let judges = {};
        ajax('GET', '/api/sessions/' + session_id + '/rounds', {}, function (a) {
            $('#round_lst').empty();
            for (const i in a.data)
            {
                var str_judges = '';
                for (const j in a.data[i].judges)
                    str_judges += a.data[i].judges[j].name_cn + ', ';
                str_judges = str_judges.slice(0, -2);
                judges[i] = a.data[i].judges;

                $('#round_lst').append(`
                    <h5 style="margin: 0;">場次編號：${i}</h5>
                    <div style="display: flex; justify-content: space-between;">
                        <div class="col-12 col-sm-6">
                            <p style="margin: 0;">正方：
                                ${(a.data[i].candidates.hasOwnProperty('pos')) ? 
                                    a.data[i].candidates['pos'].name_cn + '（' + a.data[i].candidates['pos'].school_cn + '）' : ''}
                            </p>
                            <p style="margin: 0;">反方：
                                ${(a.data[i].candidates.hasOwnProperty('neg')) ? 
                                    a.data[i].candidates['neg'].name_cn + '（' + a.data[i].candidates['neg'].school_cn + '）' : ''}
                            </p>
                            <p style="margin: 0;"><b>裁判清單：${str_judges}</b></p>
                        </div>
                        <div class="col-12 col-sm-6">
                            <div class="col-12 d-flex align-items-end">
                            <select class="form-control selectpicker judge-select" 
                                    data-selected-text-format="count" data-size="5"
                                    data-session="${session_id}" data-room="${i}" multiple>
                            </select>
                            </div>
                            <div class="col-12 d-flex align-items-end">
                                <button class="btn btn-success update-judge-btn mb-0 mt-1"
                                        data-session="${session_id}" data-room="${i}">UPDATE</button>
                            </div>
                        </div>
                    </div>
                    <hr>
                `);
            }
            ajax('GET', '/api/users/list/judges', {}, function (a) {
                for(const i in a.data)
                {
                    $('.judge-select').append(`
                        <option value="${a.data[i].id}">${a.data[i].name_cn}</option>
                    `);
                }
                $('.judge-select').selectpicker('refresh');

                for(const i in judges)
                {
                    let val = [], session_id = 0, round_number = 0;
                    for(const j in judges[i])
                    {
                        val.push(judges[i][j].user_id);
                        session_id = judges[i][j].session_id;
                        round_number = judges[i][j].round_number;
                    }
                    if (session_id != 0 && round_number != 0)
                    {
                        $('.judge-select[data-session="' + session_id + '"][data-room="' + round_number + '"]').selectpicker('val', val);
                        $('.judge-select[data-session="' + session_id + '"][data-room="' + round_number + '"]').selectpicker('refresh');    
                    }
                }
            });
        });
    }

    $(document).on('click', '.update-judge-btn', function () {
        var sessionId = $(this).data('session');
        var roomId = $(this).data('room');
        var val = $('.judge-select[data-session="' + sessionId + '"][data-room="' + roomId + '"]').val();
        // for (const i in val)
        {
            var data = {
                session_id: sessionId,
                round_number: roomId,
                user_id: val,
                role: 3,
            };
            console.log(data);
            
            ajax('POST', '/api/rounds/judges', data, function (a) {
                getRoundLst(sessionId);
            });
        }
    });

    $('#pills-signup-tab').click(function () {
        table.ajax.reload();
    });
});
