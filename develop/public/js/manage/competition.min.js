$(document).ready(function(){

    var tid = "competition", 
        object = {
            candidates : {},
            judges : {},
        };

    var getinfo = function(id){
        ajax('GET', '/api/' + tid + '/'+id, {}, function (a) {
            if(a.success){
                $('#edit_tag').val(a.data.tag);
                $('#edit_title').val(a.data.title);
                $('#edit_t_write').val(a.data.t_write);
                $('#edit_t_read').val(a.data.t_read);
                $('#edit_t_debate').val(a.data.t_debate);
                competition_time.setDate(moment.unix(a.data.date).format("YYYY/MM/DD hh:mm:ss"));
                $('#md-method').text("編輯");
                $('.save-btn').data("action", "edit");
                $('.save-btn').data("id", a.data.id);
                $(".delete-btn[data-action='delete']").hide();
                $(".com-detail").show();
                // $(".delete-btn[data-action='delete']").data('id', a.data.id);
                getcandidates();
                getJudges();
                $('#' + tid + '_modal').modal({
                    backdrop: 'static',
                    keyboard: true,
                    show: true
                });
            }else
                $.growl.error({message: a.message})
        });
    }, isJoin = function(list, id){
        return (false);
    }, getcandidates = function(){
        ajax('GET', '/api/users/list/candidates', {}, function (a) {
            if(a.success){
                $('#select_candidates').empty();
                for (const i in a.data)
                {
                    const _this = a.data[i];
                    object.candidates[_this.id] = _this;
                    if (!isJoin(object.candidates, _this.id))
                        $('#select_candidates').append('<option data-subtext="' + _this.school_cn +'" value="' + _this.id +'">[' + _this.account + '] ' + _this.name_cn +'</option>');
                }
                $('#select_candidates').selectpicker('reset');
                $('#select_candidates').selectpicker('refresh');
                getSessionList($('.save-btn').data("id"));
                getSessionJudges($('.save-btn').data("id"));
            }else
                $.growl.error({message: a.message})
        });
    }, getJudges = function(){
        ajax('GET', '/api/users/list/judges', {}, function (a) {
            if(a.success){
                $('#select_judges').empty();
                for (const i in a.data)
                {
                    const _this = a.data[i];
                    object.judges[_this.id] = _this;
                    if (!isJoin(object.judges, _this.id))
                        $('#select_judges').append('<option data-subtext="' + _this.school_cn +'" value="' + _this.id +'">[' + _this.account + '] ' + _this.name_cn +'</option>');
                }
                $('#select_judges').selectpicker('refresh');
            }else
                $.growl.error({message: a.message})
        });
    }, getSessionList = function(id){
        ajax('GET', '/api/sessions/candidates/' + id, {}, function (a) {
            if(a.success){
               $('#candidate_list').empty();
               for (const i in a.data)
               {
                    const _this = a.data[i];
                    $('#candidate_list').append('<tr>');
                    $('#candidate_list').append('<td>' + _this.roomid + '</td>');
                    $('#candidate_list').append('<td>' +  object.candidates[_this.mid].name_cn + '</td>');
                    $('#candidate_list').append('<td>' + _this.role + '</td>');
                    $('#candidate_list').append('<td>' + _this.status + '</td>');
                    $('#candidate_list').append('<td>' + _this.score + '</td>');
                    $('#candidate_list').append('</tr>');
               }
            }else
                $.growl.error({message: a.message})
        }); 
    }, getSessionJudges = function(id){
        ajax('GET', '/api/sessions/judges/' + id, {}, function (a) {
            if(a.success){
               $('#judges_list').empty();
               for (const i in a.data)
               {
                    const _this = a.data[i];
                    $('#judges_list').append('<tr>');
                    $('#judges_list').append('<td>' + object.judges[_this.mid].name_cn + '</td>');
                    $('#judges_list').append('<td>' + _this.status + '</td>');
                    $('#judges_list').append('<td>' + _this.score + '</td>');
                    $('#judges_list').append('</tr>');
               }
            }else
                $.growl.error({message: a.message})
        }); 
    };

    $('[data-admin=' + tid + ']').addClass('active');

    let competition_time = $("#datetimepicker_competition_time").flatpickr({
        altInput: true,
        dateFormat: "Y-m-   d",
        enableTime: true,
        dateFormat: "Y-m-d H:i",
        defaultDate: new Date(),
    });

    var table = $('#' + tid + 'Table').DataTable({
        responsive: true,
        searching: true,
        ajax: '/api/' + tid + '/adminlist',
        columns: [
            { data: 'operate' },
            { data: 'tag' },
            { data: 'title' },
            { data: 'date' },
            { data: 'candidates' },
        ],
        "drawCallback": function (settings) {
            $( ".date-convert" ).each(function( index ) {
                var _tmp = moment.unix($(this).text()).format("YYYY/MM/DD hh:mm:ss");
                $( this ).text(_tmp);
              });
        },
    });
    
    $('#' + tid + 'Table_filter').addClass('row');
    $('#' + tid + 'Table_filter').addClass('justify-content-end');
    var addBtn = '<button type="button" class="btn btn-primary" id="addBtn">新增</button>';
    var search = $('#' + tid + 'Table_filter').html();
    // $('#' + tid + 'Table_filter').html(search+addBtn);
    $('#' + tid + 'Table_filter').html(addBtn);

    $(document).on('click', '#addBtn', function () {
        $('#edit_tag').val("");
        $('#edit_title').val("");
        $('#edit_t_write').val("");
        $('#edit_t_read').val("");
        $('#edit_t_debate').val("");
        competition_time.setDate(moment.unix((new Date() / 1000)).format("YYYY/MM/DD hh:mm:ss"));
        $('.save-btn').data("action", "add");
        $('.save-btn').data("id", "");
        $('#md-method').text("新增");
        $("[data-action='delete']").hide();
        $(".com-detail").hide();
        $('#' + tid + '_modal').modal({
            backdrop: 'static',
            keyboard: true,
            show: true
        });
    });

    $(document).on('click', '.edit-btn', function () {
        var id = $(this).data('id');
        getinfo(id);
    });

    $(document).on('click', '.save-btn', function () {
        var data = {
            'tag': $('#edit_tag').val(),
            'title': $('#edit_title').val(),
            'date': moment($('#datetimepicker_competition_time').val()).unix(),
            't_write': $('#edit_t_write').val(),
            't_read': $('#edit_t_read').val(),
            't_debate': $('#edit_t_debate').val(),
            'token': getCookie('Authorization')
        };
        var url = '/api/competition/create', _method = 'POST';
        var action = $(this).data('action');
        if(action == 'edit')
        {
            data['id'] = $(this).data('id');
            url = '/api/' + tid + '/'+$(this).data('id'), _method = 'PUT';
        }
        ajax(_method, url, data, function (a) {
            if(a.success){
                document.cookie = "Authorization="+a.token;
                table.ajax.reload();
                // getinfo(a.message);
                $.growl.notice({message: '儲存成功'})
            }else
                $.growl.error({message: a.message})
        }); 
    });

    $('#select_candidates').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
        var data = {
            'mid': this.value,
            'cid': $('.save-btn').data("id"),
            'token': getCookie('Authorization')
        };
        ajax('POST', '/api/sessions/create', data, function (a) {
            if(a.success){
                document.cookie = "Authorization="+a.token;
                getSessionList(data.cid);
                $.growl.notice({message: '儲存成功'})
            }else
                $.growl.error({message: a.message})
        }); 
    });

    
    $('#select_judges').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
        var data = {
            'mid': this.value,
            'cid': $('.save-btn').data("id"),
            'role': 3,
            'token': getCookie('Authorization')
        };
        ajax('POST', '/api/sessions/create', data, function (a) {
            if(a.success){
                document.cookie = "Authorization="+a.token;
                getSessionJudges(data.cid);
                $.growl.notice({message: '儲存成功'})
            }else
                $.growl.error({message: a.message})
        }); 
    });
      

    // $(document).on('click', '.delete-btn', function () {
    //     var id = $(this).data('id'), token = getCookie('Authorization');
    //     $('#' + tid + '_modal').modal('hide');
    //     bootbox.confirm({
    //         size:"small",
    //         title:"刪除最新消息",
    //         message:"是否確定刪除最新消息 #"+ id,
    //         centerVertical:true,
    //         buttons: {
    //             confirm: {label: 'Yes',className: 'btn-danger'},
    //             cancel: {label: 'No',className: 'btn-secondary'}
    //         },
    //         callback:function(result){
    //             if(result){
    //                 ajax('DELETE', '/api/' + tid + '/' + id + '/' + token, {}, function (a) {
    //                     console.log(a);
    //                     if(a.success){
    //                         document.cookie = "Authorization="+a.token;
    //                         table.ajax.reload();
    //                     }else
    //                         $.growl.error({message: a.message})
    //                 });
    //             }else{
    //                 $('#' + tid + '_modal').modal({
    //                     backdrop: 'static',
    //                     keyboard: true,
    //                     show: true
    //                 });
    //             }
    //         }
    //     });
    // });

});
