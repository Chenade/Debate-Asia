$(document).ready(function () {
    
    var tid = "competitions";

    var object = {};

    function getCompetition()
    {
        ajax('GET', '/api/' + tid, {}, function (a) {
            console.log(a);
            $("#competition_lst").empty();
            for (const i in a.data)
            {
                $('#competition_lst').append(`
                    <div class="col-12 competition-item" data-id="${a.data[i].id}"
                            style="border: solid #bbb 1px; padding: 10px;">
                            <h4 style="font-weight: 700; margin: 0">${a.data[i].competition_name}</h4>
                            <span>開始時間：${a.data[i].start_date}</span><br>
                            <span>結束時間：${a.data[i].end_date}</span>
                    </div>
                `);
            }
        });
    }

    function getCompetitionItem(competitionId)
    {
        ajax('GET', '/api/' + tid + '/' + competitionId, {}, function (a) {
            if (!a.error)
            {
                $('#competition_id').val(a.data.id);
                $('#edit_competition_name').val(a.data.competition_name);
                $('#edit_competition_start').val(a.data.start_date);
                $('#edit_competition_end').val(a.data.end_date);

                $('.nav-details').show();
                $('#group_lst').empty();
                for (const i in a.groups)
                {
                    $('#group_lst').append(`
                        <tr>
                            <td><input type="text" class="form-control edit_group_name" data-id="${a.groups[i].id}" value="${a.groups[i].group_name}"></td>
                            <td><input type="number" class="form-control t_write" data-id="${a.groups[i].id}" value="${a.groups[i].t_write}"></td>
                            <td><input type="number" class="form-control t_read" data-id="${a.groups[i].id}" value="${a.groups[i].t_read}"></td>
                            <td><input type="number" class="form-control t_debate" data-id="${a.groups[i].id}" value="${a.groups[i].t_debate}"></td>
                            <td><button class="btn btn-success group-save-btn" data-id="${a.groups[i].id}">SAVE</button></td>
                        </tr>
                    `);
                }
                var newAjaxUrl = '/api/users/signup/list?competition_id=' + a.data.id + '&token=' + getCookie('Authorization');
                table.ajax.url(newAjaxUrl).load();
            }
        });
    };

    var table = $('#signupTable').DataTable({
        responsive: true,
        searching: true,
        ajax: {
            'url': '/api/users/signup/list?competition_id=1',
            'type': 'GET',
            'beforeSend': function (request) {
                request.setRequestHeader("token", getCookie('Authorization'));
            },
            error: function (xhr, error, thrown) {
                // $.growl.error({message: '連線逾時，請重新登入'});
                // setTimeout(() => {
                //     window.location.href = '/';
                // }, 1500);
            },
        },
        width: '100%',
        columns: [
            { data: 'group_name' },
            { data: 'name_cn' },
            { data: 'school_cn' },
            {
                data: 'approval',
                render: function (data, type, row) {
                    if (type === 'display') {
                        return '<input type="checkbox" ' + (data === 1 ? 'checked' : '') + ' disabled>';
                    }
                    return data;
                }
            },
            {
                data: 'id',
                render: function (data, type, row) {
                    if (type === 'display') {
                        return '<button class="btn btn-sm btn-secondary view-btn" data-id="' + data + '">View</button>';
                    }
                    return data;
                }
            }
        ],
        "drawCallback": function (settings) {
        },
    });

    getCompetition();

    $(document).on('click', '.competition-item', function () {
        var competitionId = $(this).data('id');
        getCompetitionItem(competitionId);
    });

    $('.competition-add-btn').click(function () {
        $('#competition_id').val('');
        $('#edit_competition_name').val('');
        $('#edit_competition_start').val('');
        $('#edit_competition_end').val('');
        $('.nav-details').hide();
    });

    $('.competition-save-btn').click(function () {

        var competitionId = $('#competition_id').val();

        var data = {
            id : $('#competition_id').val(),
            competition_name: $('#edit_competition_name').val(),
            start_date: $('#edit_competition_start').val(),
            end_date: $('#edit_competition_end').val(),
        };
        const _method = (competitionId === '') ? 'POST' : 'PUT';
        const _url = (competitionId === '') ? '/api/competitions' : '/api/competitions/' + competitionId;
        
        $.ajax({
            url: _url,
            method: _method,
            data: data,
            success: function (response) {
                getCompetition();
                getCompetitionItem(response.data.id);
            },
            error: function (xhr, status, error) {
                console.error(error);
            },
        });

    });

    // Delete Button Clicked
    $('.competition-delete-btn').click(function () {
        // Get competition ID from the button's data attribute
        var competitionId = $(this).data('id');

        // Perform an AJAX request to delete competition by ID
        $.ajax({
            url: '/api/competitions/' + competitionId, // Update the API endpoint to match your route
            method: 'DELETE',
            success: function (response) {
                // Handle the success response, e.g., refresh the DataTable
                $('#competitionTable').DataTable().ajax.reload();
                $('#competition_modal').modal('hide');
            },
            error: function (xhr, status, error) {
                // Handle the error, e.g., show an error message
                console.error(error);
            },
        });
    });

    $('.group-add-btn').click(function () {
        var data = {
            group_name: $('#add_group_name').val(),
            competition_id: $('#competition_id').val()
        };

        $.ajax({
            url: '/api/groups',
            method: 'POST',
            data: data,
            success: function (response) {
                console.log(response);
                // $('#groupTable').DataTable().ajax.reload();
                // $('#group_modal').modal('hide');
            },
            error: function (xhr, status, error) {
                console.error(error);
            },
        });
    });

    $(document).on('click', '.group-save-btn', function () {
        var groupId = $(this).data('id');
        var data = {
            group_name: $('.edit_group_name[data-id="' + groupId + '"]').val(),
            t_write: $('.t_write[data-id="' + groupId + '"]').val(),
            t_read: $('.t_read[data-id="' + groupId + '"]').val(),
            t_debate: $('.t_debate[data-id="' + groupId + '"]').val(),
        };
        ajax('PUT', '/api/groups/' + groupId, data, function (a) {
            console.log(a);
        });
    });

    $(document).on('click', '.view-btn', function () {
        var logId = $(this).data('id');
        console.log(logId);
        $.ajax({
            url: '/api/users/signup/' + logId,
            method: 'GET',
            success: function (a) {
                $('#competition_modal').modal('show');
                $('.approval-btn').data('id', a.data.id);

                $('#edit_account').html(a.data.account);
                $('#edit_email').html(a.data.email);
                $('#edit_chinese_name').html(a.data.name_cn);
                $('#edit_english_name').html(a.data.name_en);
                $('#edit_gender').val(a.data.gender);
                $('#edit_gender').selectpicker('refresh');
                $('#edit_birthday').val(moment.unix(a.data.birthday).format("YYYY-MM-DD"));
                $('#edit_cellphone').html(a.data.cellphone);
                $('#edit_wechat').html(a.data.wechat);
                $('#edit_address').html(a.data.address);
                $('#edit_region').html(a.data.region);
                $('#edit_school').html(a.data.school_cn);
                $('#edit_mentor').html(a.data.mentor);

                $('#edit_group').html(a.data.group_name);
                $('#edit_date').html(a.data.date);
                $('#edit_language').html(a.data.language);
                $('#edit_input').html(a.data.language);
                
                $('#edit_invoice_name').html(a.data.invoice_name);
                $('#edit_invoice_no').html(a.data.invoice_no);

                $('.selectpicker').selectpicker('refresh');
                
                if (a.data.proof === 'none')
                {
                    $('#competition_img').hide();
                    $('#edit_noproof').prop('checked', true);
                }
                else
                {
                    $('#competition_img').attr('src', '/upload/Image/proof/' + a.data.proof);
                    $('#competition_img').show();
                    $('#edit_noproof').prop('checked', false);
                }

                if (a.data.approval === 1)
                    $('.approval-btn').hide();
                else
                    $('.approval-btn').show();
            },
            error: function (xhr, status, error) {
                console.error(error);
            }
        });
    });

    $(document).on('click', '.approval-btn', function () {
        var logId = $(this).data('id');
        $.ajax({
            url: '/api/users/signup/' + logId + '/approval',
            method: 'POST',
            data: {},
            success: function (response) {
                $('#competition_modal').modal('hide');
                table.ajax.reload();
            },
            error: function (xhr, status, error) {
                console.error(error);
            }
        });
    });


    
});
