$(document).ready(function(){

    var tid = "competition", 
        object = {
            candidates : {},
            judges : {},
        };

    var convertStatus = function(status){
        switch (status) {
            case 0:
                return "未開始";
            case 1:
                return "立論環節";
            case 2:
                return "閱讀環節";
            case 3:
                return "駁論環節";
            case 4:
                return "比賽結束";
            case 5:
                return "評分結束";
            case 6:
                return "排名結束";
            default:
                break;
        }
    }

    var convertJudgeStatus = function(status){
        switch (status) {
            case 0:
                return "未開始";
            case 1:
                return "未評分";
            case 2:
                return "評分中";
            case 3:
                return "評分結束";
            default:
                break;
        }
    }

    var getinfo = function(id){
        ajax('GET', '/api/' + tid + '/'+id, {}, function (a) {
            if(a.success){
                $('#edit_tag').val(a.data.tag);
                $('#edit_title').val(a.data.title);
                $('#edit_t_write').val(a.data.t_write);
                $('#edit_t_read').val(a.data.t_read);
                $('#edit_t_debate').val(a.data.t_debate);
                competition_time.setDate(moment.unix(a.data.date).format("YYYY/MM/DD HH:mm:ss"));
                $('#md-method').text("編輯");
                $('.save-btn').data("action", "edit");
                $('.save-btn').data("id", a.data.id);
                $('.judge-end-btn').data("id", a.data.id);
                $('.judge-end-btn').show();
                $('.pair-btn').data("id", a.data.id);
                if (moment().unix() < a.data.date)
                    $('.pair-btn').show();
                else
                    $('.pair-btn').hide();
                $(".delete-btn[data-action='delete']").hide();
                $(".com-detail").show();
                // $(".delete-btn[data-action='delete']").data('id', a.data.id);
                getcandidates();
                getJudges();
                $('#' + tid + '_modal').modal({
                    backdrop: 'static',
                    keyboard: true,
                    show: true
                });
            }else
                $.growl.error({message: a.message})
        });
    }, isJoin = function(list, id){
        return (false);
    }, getcandidates = function(){
        ajax('GET', '/api/users/list/candidates', {}, function (a) {
            if(a.success){
                $('#select_candidates').empty();
                for (const i in a.data)
                {
                    const _this = a.data[i];
                    object.candidates[_this.id] = _this;
                    if (!isJoin(object.candidates, _this.id))
                        $('#select_candidates').append('<option data-subtext="' + _this.school_cn +'" value="' + _this.id +'">[' + _this.account + '] ' + _this.name_cn +'</option>');
                }
                $('#select_candidates').selectpicker('reset');
                $('#select_candidates').selectpicker('refresh');
                getSessionList($('.save-btn').data("id"));
                getSessionJudges($('.save-btn').data("id"));
            }else
                $.growl.error({message: a.message})
        });
    }, getJudges = function(){
        ajax('GET', '/api/users/list/judges', {}, function (a) {
            if(a.success){
                $('#select_judges').empty();
                for (const i in a.data)
                {
                    const _this = a.data[i];
                    object.judges[_this.id] = _this;
                    if (!isJoin(object.judges, _this.id))
                        $('#select_judges').append('<option data-subtext="' + _this.school_cn +'" value="' + _this.id +'">[' + _this.account + '] ' + _this.name_cn +'</option>');
                }
                $('#select_judges').selectpicker('refresh');
            }else
                $.growl.error({message: a.message})
        });
    }, getSessionList = function(id){
        ajax('GET', '/api/sessions/candidates/' + id, {}, function (a) {
            if(a.success){
               $('#candidate_list').empty();
               for (const i in a.data)
               {
                    const _this = a.data[i];
                    $('#candidate_list').append('<tr>');
                    $('#candidate_list').append('<td class="col-2"><input type="number" min="1" class="s-rid col-6" data-id="' + _this.id + '" data-cid="' + _this.cid + '" value="' + _this.roomid + '"/></td>');
                    $('#candidate_list').append('<td class="col-2">' +  object.candidates[_this.mid].name_cn + '</td>');
                    $('#candidate_list').append('<td class="col-2"><select class="s-role" data-id="' + _this.id + '" data-cid="' + _this.cid + '"><option value="0">未指定</option><option value="1">正方</option><option value="2">反方</option></select></td>');
                    $('#candidate_list').append('<td class="col-2">' + convertStatus(_this.status) + '</td>');
                    $('#candidate_list').append('<td class="col-2">' + _this.score + '</td>');
                    $('#candidate_list').append('<td class="col-2"><button class="btn btn-danger del-candidate" data-cid="' + _this.cid + '" data-mid="' + _this.mid + '"><i class="fa-solid fa-trash"></i></button><button class="btn btn-success update-candidate" data-id="' + _this.id + '" data-cid="' + _this.cid + '" ><i class="fa-solid fa-floppy-disk"></i></button></td>');
                    $('#candidate_list').append('</tr>');
                    if (i % 2 != 0)
                    {
                        $('#candidate_list').append('<tr>');
                        $('#candidate_list').append('<td>評審設定：</td>');
                        $('#candidate_list').append('<td colspan="4"><input type="text" class="col-12 judge-note" data-id="' +  _this.id + '"  data-cid="' + _this.cid + '" data-mid="' + _this.mid + '" value="'+ (_this.judge_note ? (_this.judge_note) : "") + '" /></td>');
                        $('#candidate_list').append('<td><button class="btn btn-success update-judge" data-id="' +  _this.id + '"  data-cid="' + _this.cid + '" data-mid="' + _this.mid + '" ><i class="fa-solid fa-floppy-disk"></i></button></td>');
                        $('#candidate_list').append('</tr>');
                    }
                    $('.s-role[data-id='+ _this.id +']').val(_this.role);
               }
            }else
                $.growl.error({message: a.message})
        }); 
    }, getSessionJudges = function(id){
        ajax('GET', '/api/sessions/judges/' + id, {}, function (a) {
            if(a.success){
                console.log(a.data);
               $('#judges_list').empty();
               for (const i in a.data)
               {
                    const _this = a.data[i];
                    $('#judges_list').append('<tr>');
                    $('#judges_list').append('<td>' + object.judges[_this.mid].name_cn + '</td>');
                    $('#judges_list').append('<td>' + convertJudgeStatus( _this.status) + '</td>');
                    $('#judges_list').append('<td class="col-2"><button class="btn btn-danger del-judge" data-cid="' + _this.cid + '" data-mid="' + _this.mid + '"><i class="fa-solid fa-trash"></i></button></td>');
                    $('#judges_list').append('</tr>');
               }
            }else
                $.growl.error({message: a.message})
        }); 
    };

    $('[data-admin=' + tid + ']').addClass('active');

    let competition_time = $("#datetimepicker_competition_time").flatpickr({
        altInput: true,
        dateFormat: "Y-m-d",
        enableTime: true,
        dateFormat: "Y-m-d H:i",
        defaultDate: new Date(),
    });

    var table = $('#' + tid + 'Table').DataTable({
        responsive: true,
        searching: true,
        ajax: {
            'url': '/api/admin/' + tid + '/list',
            'type': 'GET',
            'beforeSend': function (request) {
                request.setRequestHeader("token", getCookie('Authorization'));
            },
            error: function (xhr, error, thrown) {
                $.growl.error({message: '連線逾時，請重新登入'});
                setTimeout(() => {
                    window.location.href = '/';
                }, 1500);
            },
        },
        columns: [
            { data: 'operate' },
            { data: 'tag' },
            { data: 'title' },
            { data: 'date' },
            { data: 'candidates' },
        ],
        "drawCallback": function (settings) {
            $( ".date-convert" ).each(function( index ) {
                var _tmp = moment.unix($(this).text()).format("YYYY/MM/DD HH:mm:ss");
                // console.log($(this).text());
                $( this ).text(_tmp);
              });
        },
    });
    
    $('#' + tid + 'Table_filter').addClass('row');
    $('#' + tid + 'Table_filter').addClass('justify-content-end');
    var addBtn = '<button type="button" class="btn btn-primary" id="addBtn">新增</button>';
    var search = $('#' + tid + 'Table_filter').html();
    // $('#' + tid + 'Table_filter').html(search+addBtn);
    $('#' + tid + 'Table_filter').html(addBtn);

    $(document).on('click', '#addBtn', function () {
        $('#edit_tag').val("");
        $('#edit_title').val("");
        $('#edit_t_write').val("");
        $('#edit_t_read').val("");
        $('#edit_t_debate').val("");
        competition_time.setDate(moment.unix((new Date() / 1000)).format("YYYY/MM/DD HH:mm:ss"));
        $('.save-btn').data("action", "add");
        $('.judge-end-btn').data("id", "");
        $('.judge-end-btn').hide();
        $('.pair-btn').data("id", "");
        $('.pair-btn').hide();
        $('#md-method').text("新增");
        $("[data-action='delete']").hide();
        $(".com-detail").hide();
        $('#' + tid + '_modal').modal({
            backdrop: 'static',
            keyboard: true,
            show: true
        });
    });

    $(document).on('click', '.edit-btn', function () {
        var id = $(this).data('id');
        getinfo(id);
    });

    $(document).on('click', '.save-btn', function () {
        var data = {
            'tag': $('#edit_tag').val(),
            'title': $('#edit_title').val(),
            'date': moment($('#datetimepicker_competition_time').val()).unix(),
            't_write': $('#edit_t_write').val(),
            't_read': $('#edit_t_read').val(),
            't_debate': $('#edit_t_debate').val(),
            'token': getCookie('Authorization')
        };
        var url = '/api/competition/create', _method = 'POST';
        var action = $(this).data('action');
        if(action == 'edit')
        {
            data['id'] = $(this).data('id');
            url = '/api/' + tid + '/'+$(this).data('id'), _method = 'PUT';
        }
        ajax(_method, url, data, function (a) {
            if(a.success){
                document.cookie = "Authorization="+a.token;
                table.ajax.reload();
                // getinfo(a.message);
                $.growl.notice({message: '儲存成功'})
            }else
                $.growl.error({message: a.message})
        }); 
    });

    $(document).on('click', '.pair-btn', function () {
        const cid = $('.pair-btn').data('id');
        ajax('POST', '/api/sessions/pairs/' + cid, {}, function (a) {
            if(a.success){
                $.growl.notice({message: '配對成功'})
                getSessionList(cid);
            }else
                $.growl.error({message: a.message})
        }); 
    });

    $(document).on('click', '.judge-end-btn', function () {
        const cid = $('.judge-end-btn').data('id');
        ajax('POST', '/api/judges/' + cid + '/end', {}, function (a) {
            if(a.success){
                $.growl.notice({message: '修改成功'})
                getSessionJudges(cid);
                getSessionList(cid);
            }else
                $.growl.error({message: a.message})
        }); 
    });

    $(document).on('click', '.update-candidate', function () {
        const sid = $(this).data('id');
        const cid = $(this).data('cid');
        const data = {
            roomid: $('.s-rid[data-id="'+ sid +'"]').val(),
            role: $('.s-role[data-id="'+ sid +'"]').val(),
        }
        ajax('PUT', '/api/sessions/' + sid, data, function (a) {
            if(a.success){
                $.growl.notice({message: '修改成功'})
                getSessionList(cid);
            }else
                $.growl.error({message: a.message})
        }); 
    });

    $(document).on('click', '.update-judge', function () {
        const sid = $(this).data('id');
        const cid = $(this).data('cid');
        const id = $(this).data('id');
        const data = {
            judge_note: $('.judge-note[data-id="'+ sid +'"]').val(),
        }
        ajax('PUT', '/api/sessions/' + id, data, function (a) {
            if(a.success){
                $.growl.notice({message: '修改成功'})
                getSessionList(cid);
            }else
                $.growl.error({message: a.message})
        }); 
    });

    
    $(document).on('click', '.del-candidate', function () {
        const data = {
            cid: $(this).data('cid'),
            mid: $(this).data('mid'),
        }
        ajax('POST', '/api/sessions/delete', data, function (a) {
            if(a.success){
                $.growl.notice({message: '刪除成功'})
                getSessionList(data.cid);
            }else
                $.growl.error({message: a.message})
        }); 
    });

    
    $(document).on('click', '.del-judge', function () {
        const data = {
            cid: $(this).data('cid'),
            mid: $(this).data('mid'),
        }
        ajax('POST', '/api/sessions/delete', data, function (a) {
            if(a.success){
                $.growl.notice({message: '刪除成功'})
                getSessionJudges(data.cid);
            }else
                $.growl.error({message: a.message})
        }); 
    });

    $('#select_candidates').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
        var data = {
            'mid': this.value,
            'cid': $('.save-btn').data("id"),
            'token': getCookie('Authorization')
        };
        ajax('POST', '/api/sessions/create', data, function (a) {
            if(a.success){
                document.cookie = "Authorization="+a.token;
                getSessionList(data.cid);
                $.growl.notice({message: '儲存成功'})
            }else
                $.growl.error({message: a.message})
        }); 
    });
    
    $('#select_judges').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
        var data = {
            'mid': this.value,
            'cid': $('.save-btn').data("id"),
            'role': 3,
            'token': getCookie('Authorization')
        };
        ajax('POST', '/api/sessions/create', data, function (a) {
            if(a.success){
                document.cookie = "Authorization="+a.token;
                getSessionJudges(data.cid);
                $.growl.notice({message: '儲存成功'})
            }else
                $.growl.error({message: a.message})
        }); 
    });
});
