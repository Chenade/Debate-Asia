
$(document).ready(function(){
    
    
    var tid = "users";
    
    var getinfo = function(id){
        ajax('GET', '/api/' + tid + '/'+id, {}, function (a) {
            if(a.success){
                $('#edit_authority').val(a.data.authority).selectpicker('refresh');
                $('#edit_email').val(a.data.email);
                $('#edit_account').val(a.data.account);
                $('#edit_password').val(a.data.password);
                $('#edit_school_cn').val(a.data.school_cn);
                $('#edit_school_zh').val(a.data.school_zh);
                $('#edit_name_cn').val(a.data.name_cn);
                $('#edit_name_zh').val(a.data.name_zh);
                $('#edit_cellphone').val(a.data.cellphone);
                $('#edit_wechat').val(a.data.wechat);
                $('#edit_whatsapp').val(a.data.whatsapp);
                $('#edit_linid').val(a.data.lineid);
                birthday.setDate(moment.unix(a.data.birthday).format("YYYY/MM/DD hh:mm:ss"));
                $('#md-method').text("編輯");
                $('.save-btn').data("action", "edit");
                $('.save-btn').data("id", a.data.id);
                $(".delete-btn[data-action='delete']").hide();
                // $(".delete-btn[data-action='delete']").data('id', a.data.id);

                $('#' + tid + '_modal').modal({
                    backdrop: 'static',
                    keyboard: true,
                    show: true
                });
            }else
                $.growl.error({message: a.message})
        });
    };

    $('[data-admin=' + tid + ']').addClass('active');

    let birthday = $("#datetimepicker_birthday").flatpickr({
        altInput: true,
        dateFormat: "Y-m-d",
        enableTime: true,
        dateFormat: "Y-m-d H:i",
        defaultDate: new Date(),
    });

    {
        var table = $('#' + tid + 'Table').DataTable({
            responsive: true,
            searching: true,
            ajax: {
                'url': '/api/admin/' + tid + '/list',
                'type': 'GET',
                'beforeSend': function (request) {
                    request.setRequestHeader("token", getCookie('Authorization'));
                },
                error: function (xhr, error, thrown) {
                    $.growl.error({message: '連線逾時，請重新登入'});
                    setTimeout(() => {
                        // window.location.href = '/';
                    }, 1500);
                },
            },
            columns: [
                { data: 'operate' },
                { data: 'type' },
                { data: 'school' },
                { data: 'name' },
                { data: 'account' },
                { data: 'authority' },
            ],
            
            "drawCallback": function (settings) {
                // $( ".date-convert" ).each(function( index ) {
                //     var _tmp = moment.unix($(this).text()).format("YYYY/MM/DD hh:mm:ss");
                //     $( this ).text(_tmp);
                //   });
            },
        });
    }
    
    $('#' + tid + 'Table_filter').addClass('row');
    $('#' + tid + 'Table_filter').addClass('justify-content-end');
    var addBtn = '<button type="button" class="btn btn-primary" id="addBtn">新增</button>';
    var search = $('#' + tid + 'Table_filter').html();
    // $('#' + tid + 'Table_filter').html(search+addBtn);
    $('#' + tid + 'Table_filter').html(addBtn);

    $(document).on('click', '#addBtn', function () {
        $('#edit_category').val(1).selectpicker('refresh');
        $('#edit_title').val("");
        $('#edit_content').val("");
        $('#edit_link').val("");
        $('#edit_link_alt').val("");
        $('#edit_ord').val("");
        birthday.setDate(moment.unix((new Date() / 1000)).format("YYYY/MM/DD hh:mm:ss"));
        $('.save-btn').data("action", "add");
        $('.save-btn').data("id", "");
        $('#md-method').text("新增");
        $("[data-action='delete']").hide();
        $('.image-box').hide();
        $('#' + tid + '_modal').modal({
            backdrop: 'static',
            keyboard: true,
            show: true
        });
    });

    $(document).on('click', '.edit-btn', function () {
        var id = $(this).data('id');
        getinfo(id);
    });

    $(document).on('click', '.save-btn', function () {
        var data = {
            'authority': $('#edit_authority').val(),
            'email': $('#edit_email').val(),
            'account': $('#edit_account').val(),
            'password': $('#edit_password').val(),
            'school_cn': $('#edit_school_cn').val(),
            'school_zh': $('#edit_school_zh').val(),
            'name_cn': $('#edit_name_cn').val(),
            'name_zh': $('#edit_name_zh').val(),
            'cellphone': $('#edit_cellphone').val(),
            'birthday': moment($('#datetimepicker_birthday').val()).unix(),
            'wechat': $('#edit_wechat').val(),
            'whatsapp': $('#edit_whatsapp').val(),
            'lineid': $('#edit_linid').val(),
            'token': getCookie('Authorization')
        };
        var url = '/api/admin/signup', _method = 'POST';
        var action = $(this).data('action');
        if(action == 'edit')
        {
            data['id'] = $(this).data('id');
            url = '/api/' + tid + '/'+$(this).data('id'), _method = 'PUT';
        }
        ajax(_method, url, data, function (a) {
            if(a.success){
                document.cookie = "Authorization="+a.token;
                table.ajax.reload();
                // getinfo(a.message);
                $.growl.notice({message: '儲存成功'})
            }else
                $.growl.error({message: a.message})
        }); 
    });

});
