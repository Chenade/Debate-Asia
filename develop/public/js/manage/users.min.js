$(document).ready(function(){

    var tid = "users";

    var uploadImage = function(id){
        var imgclean = $('#file');

        data = new FormData();
        data.append('image', $('#file')[0].files[0]);
        data.append('token', getCookie('Authorization'));

        var imgname  =  $('#file').val();
        var size  =  $('#file')[0].files[0].size;

        var ext =  imgname.substr( (imgname.lastIndexOf('.') +1) );
        console.log(imgname, ext);
        if(ext=='jpg' || ext=='jpeg' || ext=='png' || ext=='gif' || ext=='PNG' || ext=='JPG' || ext=='JPEG')
        {
            if(size<=1000000)
            {
                $.growl.warning({message: '圖片上傳中'});
                $.ajax({
                    url: "/api/image/" + tid + "/" + id + "/store",
                    type: "POST",
                    data: data,
                    enctype: 'multipart/form-data',
                    processData: false,  // tell jQuery not to process the data
                    contentType: false   // tell jQuery not to set contentType
                }).done(function(a) {
                    if(a.success){
                        document.cookie = "Authorization="+a.token;
                        displayImage(id);
                        $.growl.notice({message: '圖片上傳成功'})
                        imgclean.replaceWith( imgclean = imgclean.clone( true ) );
                    }else
                        $.growl.error({message: a.message})
                });
                return false;
            }
            else
            {
                imgclean.replaceWith( imgclean = imgclean.clone( true ) );
                alert('Sorry File size exceeding from 1 Mb');
            }
        }
        else
        {
            imgclean.replaceWith( imgclean = imgclean.clone( true ) );
            alert('Sorry Only you can uplaod JPEG|JPG|PNG|GIF file type ');
        }
    }, uploadThumbnail = function(id){
        var imgclean = $('#file-t');

        data = new FormData();
        data.append('image', $('#file-t')[0].files[0]);
        data.append('token', getCookie('Authorization'));

        var imgname  =  $('#file-t').val();
        var size  =  $('#file-t')[0].files[0].size;

        var ext =  imgname.substr( (imgname.lastIndexOf('.') +1) );
        if(ext=='jpg' || ext=='jpeg' || ext=='png' || ext=='gif' || ext=='PNG' || ext=='JPG' || ext=='JPEG')
        {
            if(size<=1000000)
            {
                $.growl.warning({message: '圖片上傳中'});
                $.ajax({
                    url: "/api/" + tid + "/" + id + "/uploadThumbnail",
                    type: "POST",
                    data: data,
                    enctype: 'multipart/form-data',
                    processData: false,  // tell jQuery not to process the data
                    contentType: false   // tell jQuery not to set contentType
                }).done(function(a) {
                    if(a.success){
                        document.cookie = "Authorization="+a.token;
                        // displayThumbnail(id);
                        $.growl.notice({message: '圖片上傳成功'});
                        getinfo(id);
                        imgclean.replaceWith( imgclean = imgclean.clone( true ) );
                    }else
                        $.growl.error({message: a.message})
                });
                return false;
            }
            else
            {
                imgclean.replaceWith( imgclean = imgclean.clone( true ) );
                alert('Sorry File size exceeding from 1 Mb');
            }
        }
        else
        {
            imgclean.replaceWith( imgclean = imgclean.clone( true ) );
            alert('Sorry Only you can uplaod JPEG|JPG|PNG|GIF file type ');
        }
    }, displayImage = function(id){
        ajax('GET', '/api/image/' + tid + '/' + id + '/get', {}, function (a) {
            if(a.success){
                $('#display-img').empty();
                a.data.forEach(el => {
                    var box = '<div class="col-10 col-lg-4 d-flex flex-column align-items-center" style="margin: 10px; padding: 10px; border-radius: 10px; background-color: #e5e5e5;">';
                    box += '<div class="d-flex justify-content-center align-items-center" style="height: 180px;">';
                    box += '    <img src="/upload/Image/' + el.uuid_name + '" style="max-height: 95%;max-width: 95%">';
                    box += '</div>';
                    box += '<button type="button" class="btn btn-danger delete-image" data-id="' + el.id +'" data-pid="'+ id +'" style="margin: 0"><i class="far fa-solid fa-trash-can"></i></button>';
                    box += '</div>';
                    $('#display-img').append(box);
                });
            }else
                $.growl.error({message: a.message})
        });
    }, getinfo = function(id){
        ajax('GET', '/api/' + tid + '/'+id, {}, function (a) {
            if(a.success){
                console.log(a.data.birthday);
                $('#edit_authority').val(a.data.authority).selectpicker('refresh');
                $('#edit_email').val(a.data.email);
                $('#edit_account').val(a.data.account);
                $('#edit_password').val(a.data.password);
                $('#edit_school_cn').val(a.data.school_cn);
                $('#edit_school_zh').val(a.data.school_zh);
                $('#edit_name_cn').val(a.data.name_cn);
                $('#edit_name_zh').val(a.data.name_zh);
                $('#edit_cellphone').val(a.data.cellphone);
                $('#edit_wechat').val(a.data.wechat);
                $('#edit_whatsapp').val(a.data.whatsapp);
                $('#edit_linid').val(a.data.lineid);
                // a.data.birthday *= 1000;
                birthday.setDate(moment.unix(a.data.birthday).format("YYYY/MM/DD hh:mm:ss"));
                $('#md-method').text("編輯");
                $('.save-btn').data("action", "edit");
                $('.save-btn').data("id", a.data.id);
                $(".delete-btn[data-action='delete']").hide();
                // $(".delete-btn[data-action='delete']").data('id', a.data.id);

                $('#' + tid + '_modal').modal({
                    backdrop: 'static',
                    keyboard: true,
                    show: true
                });
            }else
                $.growl.error({message: a.message})
        });
    };

    $('[data-admin=' + tid + ']').addClass('active');

    let birthday = $("#datetimepicker_birthday").flatpickr({
        altInput: true,
        dateFormat: "Y-m-   d",
        enableTime: true,
        dateFormat: "Y-m-d H:i",
        defaultDate: new Date(),
    });

    var table = $('#' + tid + 'Table').DataTable({
        responsive: true,
        searching: true,
        ajax: '/api/' + tid + '/adminlist',
        columns: [
            { data: 'operate' },
            { data: 'type' },
            { data: 'school' },
            { data: 'name' },
            { data: 'account' },
            { data: 'authority' },
        ],
        "drawCallback": function (settings) {
            // $( ".date-convert" ).each(function( index ) {
            //     var _tmp = moment.unix($(this).text()).format("YYYY/MM/DD hh:mm:ss");
            //     $( this ).text(_tmp);
            //   });
        },
    });
    
    $('#' + tid + 'Table_filter').addClass('row');
    $('#' + tid + 'Table_filter').addClass('justify-content-end');
    var addBtn = '<button type="button" class="btn btn-primary" id="addBtn">新增</button>';
    var search = $('#' + tid + 'Table_filter').html();
    // $('#' + tid + 'Table_filter').html(search+addBtn);
    $('#' + tid + 'Table_filter').html(addBtn);

    $(document).on('click', '#addBtn', function () {
        $('#edit_category').val(1).selectpicker('refresh');
        $('#edit_title').val("");
        $('#edit_content').val("");
        $('#edit_link').val("");
        $('#edit_link_alt').val("");
        $('#edit_ord').val("");
        birthday.setDate(moment.unix((new Date() / 1000)).format("YYYY/MM/DD hh:mm:ss"));
        $('.save-btn').data("action", "add");
        $('.save-btn').data("id", "");
        $('#md-method').text("新增");
        $("[data-action='delete']").hide();
        $('.image-box').hide();
        $('#' + tid + '_modal').modal({
            backdrop: 'static',
            keyboard: true,
            show: true
        });
    });

    $(document).on('click', '.edit-btn', function () {
        var id = $(this).data('id');
        getinfo(id);
    });

    $(document).on('click', '.save-btn', function () {
        var data = {
            'authority': $('#edit_authority').val(),
            'email': $('#edit_email').val(),
            'account': $('#edit_account').val(),
            'password': $('#edit_password').val(),
            'school_cn': $('#edit_school_cn').val(),
            'school_zh': $('#edit_school_zh').val(),
            'name_cn': $('#edit_name_cn').val(),
            'name_zh': $('#edit_name_zh').val(),
            'cellphone': $('#edit_cellphone').val(),
            'birthday': moment($('#datetimepicker_birthday').val()).unix(),
            'wechat': $('#edit_wechat').val(),
            'whatsapp': $('#edit_whatsapp').val(),
            'lineid': $('#edit_linid').val(),
            'token': getCookie('Authorization')
        };
        var url = '/api/admin/signup', _method = 'POST';
        var action = $(this).data('action');
        if(action == 'edit')
        {
            data['id'] = $(this).data('id');
            url = '/api/' + tid + '/'+$(this).data('id'), _method = 'PUT';
        }
        ajax(_method, url, data, function (a) {
            if(a.success){
                document.cookie = "Authorization="+a.token;
                table.ajax.reload();
                // getinfo(a.message);
                $.growl.notice({message: '儲存成功'})
            }else
                $.growl.error({message: a.message})
        }); 
    });

    // $(document).on('click', '.delete-btn', function () {
    //     var id = $(this).data('id'), token = getCookie('Authorization');
    //     $('#' + tid + '_modal').modal('hide');
    //     bootbox.confirm({
    //         size:"small",
    //         title:"刪除最新消息",
    //         message:"是否確定刪除最新消息 #"+ id,
    //         centerVertical:true,
    //         buttons: {
    //             confirm: {label: 'Yes',className: 'btn-danger'},
    //             cancel: {label: 'No',className: 'btn-secondary'}
    //         },
    //         callback:function(result){
    //             if(result){
    //                 ajax('DELETE', '/api/' + tid + '/' + id + '/' + token, {}, function (a) {
    //                     console.log(a);
    //                     if(a.success){
    //                         document.cookie = "Authorization="+a.token;
    //                         table.ajax.reload();
    //                     }else
    //                         $.growl.error({message: a.message})
    //                 });
    //             }else{
    //                 $('#' + tid + '_modal').modal({
    //                     backdrop: 'static',
    //                     keyboard: true,
    //                     show: true
    //                 });
    //             }
    //         }
    //     });
    // });

});
