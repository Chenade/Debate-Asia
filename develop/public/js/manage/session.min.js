$(document).ready(function(){

    var tid = "session",
        object = {
            article: {}
        };

    var convertStatus = function(status){
        switch (status) {
            case 0:
                return "未開始";
            case 1:
                return "立論環節";
            case 2:
                return "閱讀環節";
            case 3:
                return "駁論環節";
            case 4:
                return "比賽結束";
            case 5:
                return "評分結束";
            case 6:
                return "排名結束";
            default:
                break;
        }
    }
    
    , getinfo = function(id){
        ajax('GET', '/api/' + tid + '/'+id, {}, function (a) {
            if(a.success){
                $('#edit_tag').val(a.data.tag);
                $('#edit_title').val(a.data.title);
                $('#edit_t_write').val(a.data.t_write);
                $('#edit_t_read').val(a.data.t_read);
                $('#edit_t_debate').val(a.data.t_debate);
                competition_time.setDate(moment.unix(a.data.date).format("YYYY/MM/DD HH:mm:ss"));
                $('#md-method').text("編輯");
                $('.save-btn').data("action", "edit");
                $('.save-btn').data("id", a.data.id);
                $('.pair-btn').data("id", a.data.id);
                if (moment().unix() < a.data.date)
                    $('.pair-btn').show();
                else
                    $('.pair-btn').hide();
                $(".delete-btn[data-action='delete']").hide();
                $(".com-detail").show();
                // $(".delete-btn[data-action='delete']").data('id', a.data.id);
                getcandidates();
                getJudges();
                $('#' + tid + '_modal').modal({
                    backdrop: 'static',
                    keyboard: true,
                    show: true
                });
            }else
                $.growl.error({message: a.message})
        });
    }, getCompetition = function(){
        ajax('GET', '/api/admin/competition/list', {}, function (a) {
            if(a.success){
                $('#select_competition').empty();
                for (const i in a.data)
                {
                    const _this = a.data[i];
                    $('#select_competition').append('<option data-subtext="' + _this.tag +'" value="' + _this.id +'">[' + _this.date + '] ' + _this.title +'</option>');
                }
                $( ".date-convert" ).each(function( index ) {
                    var _tmp = moment.unix($(this).text()).format("YYYY/MM/DD HH:mm:ss");
                    $( this ).text(_tmp);
                  });
                $('#select_competition').selectpicker('refresh');
            }else
                $.growl.error({message: a.message})
        });
    }, getSessionList = function(cid){
        ajax('GET', '/api/sessions/candidates/' + cid, {}, function (a) {
            if(a.success){
                document.cookie = "Authorization="+a.token;
                var roomid = 0, rows = "";
                i = 0;
                for (const i in a.data)
                {
                    if (i == (a.data.length) - 1) break;
                    const _this = a.data[i];
                    if (_this.roomid != 0)
                    {
                        const _next = a.data[parseInt(i) + 1];
                        if (_this.roomid != roomid)
                        {
                            rows += '<tr>';
                            rows += '<td>' + _this.roomid + '</td>';
                            rows += '<td>' + _this.name_cn;
                            rows += '<br><span style="color: #BBB;">' + _this.school_cn + '</span></td>';
                            rows += '<td><img src="/camera/' + _this.camera + '" width="50" width="50" alt="camera"/></td>';
                            rows += '<td>' + convertStatus(_this.status);
                            rows += '<br><span style="color: #BBB;">' + _this.updated_at + '</span></td>';
                            rows += '<td class="text-center">';
                            rows += '<button type="button" class="btn btn-success article-btn" style="margin:0" data-maid="' + _this.id + '" data-mbid="' + _next.id + '">' + langDict['article'] + '</button>';
                            rows += '</td>';
                            rows += '<td>' + convertStatus(_next.status);
                            rows += '<br><span style="color: #BBB;">' + _next.updated_at + '</span></td>';
                            rows += '<td><img src="/camera/' + _next.camera + '" width="50" width="50" alt="camera"/></td>';
                            rows += '<td>' + _next.name_cn;
                            rows += '<br><span style="color: #BBB;">' + _next.school_cn + '</span></td>';
                            rows += '</tr>';
                            roomid = _this.roomid;
                        }
                    }
                }
                // $('#session_list').empty();
                $('#session_list').html(rows);
                // $.growl.notice({message: '查詢成功'})
            }else
                $.growl.error({message: a.message})
        }); 
    };

    getCompetition();

    $('[data-admin=' + tid + ']').addClass('active');

    $(document).on('click', '.article-btn', function () {
        const asid = $(this).data('maid');
        const bsid = $(this).data('mbid');
        ajax('GET', '/api/admin/articles/list/' + asid + '/' + bsid, {}, function (a) {
            if(a.success){
                document.cookie = "Authorization="+a.token;
                object.article = a.data;
                if (a.data.a[0].content) $('#a_1').val(trimquotes(a.data.a[0].content));
                if (a.data.a[1].content) $('#a_2').val(trimquotes(a.data.a[1].content));
                if (a.data.b[0].content) $('#b_1').val(trimquotes(a.data.b[0].content));
                if (a.data.b[1].content) $('#b_2').val(trimquotes(a.data.b[1].content));
                $('#a_camera').attr('src', '/camera/' + a.data.candidates.a.camera);
                $('#b_camera').attr('src', '/camera/' + a.data.candidates.b.camera);
                $('#a_name').html(a.data.candidates.a.user.name_cn);
                $('#a_school').html(a.data.candidates.a.user.school_cn);
                $('#a_status').html(a.data.candidates.a['status']);
                $('#a_updated_at').html(a.data.candidates.a['updated_at']);
                $('#b_name').html(a.data.candidates.b.user.name_cn);
                $('#b_school').html(a.data.candidates.b.user.school_cn);
                $('#b_status').html(a.data.candidates.b['status']);
                $('#b_updated_at').html(a.data.candidates.b['updated_at']);
            }else
                $.growl.error({message: a.message})
        }); 

        $('#article_modal').modal({
            backdrop: 'static',
            keyboard: true,
            show: true
        });
    });

    $(document).on('click', '#addBtn', function () {
        $('#edit_tag').val("");
        $('#edit_title').val("");
        $('#edit_t_write').val("");
        $('#edit_t_read').val("");
        $('#edit_t_debate').val("");
        competition_time.setDate(moment.unix((new Date() / 1000)).format("YYYY/MM/DD HH:mm:ss"));
        $('.save-btn').data("action", "add");
        $('.save-btn').data("id", "");
        $('.pair-btn').data("id", "");
        $('.pair-btn').hide();
        $('#md-method').text("新增");
        $("[data-action='delete']").hide();
        $(".com-detail").hide();
        $('#' + tid + '_modal').modal({
            backdrop: 'static',
            keyboard: true,
            show: true
        });
    });

    $(document).on('click', '.edit-btn', function () {
        var id = $(this).data('id');
        getinfo(id);
    });

    $(document).on('click', '.save-btn', function () {
        object.article.a[0].content = $('#a_1').val() ;
        object.article.a[1].content = $('#a_2').val() ;
        object.article.b[0].content = $('#b_1').val() ;
        object.article.b[1].content = $('#b_2').val() ;
        console.log(object.article);
        ajax('PUT', '/api/articles/admin/update', object.article, function (a) {
            if(a.success){
                document.cookie = "Authorization="+a.token;
                console.log(a.data);
                $.growl.notice({message: '儲存成功'})
            }else
                $.growl.error({message: a.message})
        }); 
    });

    $('#select_competition').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
        const cid = this.value;
        getSessionList(cid);
    });

});
