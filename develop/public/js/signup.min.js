$(document).ready(function () {
    
    var tid = "competitions";

    ajax('GET', '/api/competitions/1', {}, function (a) {
        if (!a.error)
        {
            console.log(a);
            $('#edit_group').empty();
            for (const i in a.groups)
            {
                $('#edit_group').append(`
                    <option value="${a.groups[i].id}">${a.groups[i].group_name}</option>
                `);
            }
            $('#edit_group').selectpicker('refresh');

            $('#edit_date').empty();
            $('#edit_date').append(`<option value="${a.data.start_date}">${a.data.start_date}</option>`);
            $('#edit_date').append(`<option value="${a.data.end_date}">${a.data.end_date}</option>`);
            $('#edit_date').selectpicker('refresh');

        }
    });

    async function uploadProof() {
        if ($('#edit_noproof').is(':checked'))
            return 'none';
    
        var fileInput = $('#edit_proof')[0];
    
        if (fileInput.files.length > 0) {
            var formData = new FormData();
            formData.append('file', fileInput.files[0]);
    
            try {
                const response = await $.ajax({
                    url: '/api/image/upload/proof',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                });
    
                return response.content;
            } catch (error) {
                console.error(error.responseText);
                throw error; // Re-throw the error to be caught by the caller
            }
        } else {
            alert('Please select a file to upload.');
        }
    }
    
    $('.charnum').keyup(function () {
        const inputValue = $(this).val();
        const pattern = /^[a-zA-Z0-9]*$/;
        if (!pattern.test(inputValue)) {
            $(this).val(inputValue.substring(0, inputValue.length - 1));
        }
        const length = $(this).val().length;
        if (length > 20) {
            $(this).val(inputValue.substring(0, 20));
        }
        $(this).siblings('.charCount').text($(this).val().length + '/20');
    });
    
    $('#getUser').click(function () {
        var data = {
            account: $('#edit_account').val(),
            password: $('#edit_password').val(),
        };
        ajax('POST', '/api/users/info', data, function (a) {
            if (a.data)
            {
                $('#edit_email').val(a.data.email);
                $('#edit_chinese_name').val(a.data.name_zh);
                $('#edit_english_name').val(a.data.name_en);
                $('#edit_gender').val(a.data.gender);
                $('#edit_gender').selectpicker('refresh');
                $('#edit_birthday').val(moment.unix(a.data.birthday).format("YYYY-MM-DD"));

                $('#edit_cellphone').val(a.data.cellphone);
                $('#edit_wechat').val(a.data.wechat);
                $('#edit_address').val(a.data.address);
                $('#edit_region').val(a.data.region);
                $('#edit_school').val(a.data.school_zh);
                $('#edit_mentor').val(a.data.mentor);
            }
        });
    });

    $('#submit').click(async function () {

        uploadProof()
            .then(function (proof_img) {
                if (!proof_img)
                    return;
                var data = {
                    account: $('#edit_account').val(),
                    password: $('#edit_password').val(),
                    email: $('#edit_email').val(),
                    chinese_name: $('#edit_chinese_name').val(),
                    english_name: $('#edit_english_name').val(),
                    gender: $('#edit_gender').val(),
                    birthday: moment($('#edit_birthday').val()).format("X"),
                    cellphone: $('#edit_cellphone').val(),
                    wechat: $('#edit_wechat').val(),
                    address: $('#edit_address').val(),
                    region: $('#edit_region').val(),
                    school: $('#edit_school').val(),
                    
                    mentor: $('#edit_mentor').val(),
                    group: $('#edit_group').val(),
                    date: ($('#edit_date').val()),
                    language: $('#edit_language').val(),
                    invoice_name: $('#edit_invoice_name').val(),
                    invoice_no: $('#edit_invoice_no').val(),
                    proof: proof_img
                };
        
                ajax('POST', '/api/users/signup', data, function (a) {
                    console.log(a);
                    if (!a.error)
                    {
                        alert('報名成功');
                    }
                    else
                        $.growl.error({message: a.error});
                });
            })
            .catch(function (error) {
                // Handle any errors that occurred during the upload
            });


    });
        
});
