// get url parameter
function getCodeFromUrl() {
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const code = urlParams.get('code');
    if (code)
        return parseInt(code);
    else
        return 1;
}

$(document).ready(function () {
    
    var tid = "competitions";
    var competition_id = getCodeFromUrl();

    function getSessionLst(gid)
    {
        ajax('GET', '/api/groups/' + gid +'/sessions', {}, function (a) {
            if (!a.error)
            {
                $('#edit_date').empty();
                for(const i in a.data)
                    $('#edit_date').append(`<option value="${a.data[i].session_name}">${a.data[i].session_name}</option>`);
                $('#edit_date').selectpicker('refresh');
            }
        });
    }

    ajax('GET', '/api/competitions/' + competition_id, {}, function (a) {
        if (!a.error)
        {
            $('#edit_group').empty();
            for (const i in a.groups)
            {
                $('#edit_group').append(`
                    <option value="${a.groups[i].id}">${a.groups[i].group_name}</option>
                `);
            }
            $('#edit_group').val(a.groups[0].id);
            $('#edit_group').selectpicker('refresh');
            getSessionLst(a.groups[0].id);
        }
    });

    $(document).on('change', '#edit_group', function () {
        const gid = $(this).val();
        getSessionLst(gid);
    });

    async function uploadProof() {
        if ($('#edit_noproof').is(':checked'))
            return 'none';
    
        var fileInput = $('#edit_proof')[0];
    
        if (fileInput.files.length > 0) {
            var formData = new FormData();
            formData.append('file', fileInput.files[0]);
    
            try {
                const response = await $.ajax({
                    url: '/api/image/upload/proof',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                });
    
                return response.content;
            } catch (error) {
                console.error(error.responseText);
                throw error; // Re-throw the error to be caught by the caller
            }
        } else {
            alert('Please select a file to upload.');
        }
    }
    
    $('.charnum').keyup(function () {
        const inputValue = $(this).val();
        const pattern = /^[a-zA-Z0-9]*$/;
        if (!pattern.test(inputValue)) {
            $(this).val(inputValue.substring(0, inputValue.length - 1));
        }
        const length = $(this).val().length;
        if (length > 20) {
            $(this).val(inputValue.substring(0, 20));
        }
        $(this).siblings('.charCount').text($(this).val().length + '/20');
    });
    
    $('#getUser').click(function () {
        var data = {
            account: $('#edit_account').val(),
            password: $('#edit_password').val(),
        };
        ajax('POST', '/api/users/info', data, function (a) {
            if (a.data)
            {
                $('#edit_email').val(a.data.email);
                $('#edit_chinese_name').val(a.data.name_zh);
                $('#edit_english_name').val(a.data.name_en);
                $('#edit_gender').val(a.data.gender);
                $('#edit_gender').selectpicker('refresh');
                $('#edit_birthday').val(moment.unix(a.data.birthday).format("YYYY-MM-DD"));

                $('#edit_cellphone').val(a.data.cellphone);
                $('#edit_wechat').val(a.data.wechat);
                $('#edit_address').val(a.data.address);
                $('#edit_region').val(a.data.region);
                $('#edit_school').val(a.data.school_zh);
                $('#edit_mentor').val(a.data.mentor);
            }
        });
    });

    $('#submit').click(async function () {

        let allMandatoryFieldsFilled = true;

        $('.mandatory').each(function () {
            const value = $(this).val();
            if (!value || value.trim() === '' || value.length === 0) {
                allMandatoryFieldsFilled = false;
                $.growl.error({ message: '請填寫必填欄位' });
                return false;
            }
        });

        const value = $('#edit_date').val();
        if (!value || value.length === 0) {
            allMandatoryFieldsFilled = false;
            console.log($(this));
            $.growl.error({ message: '請填寫必填欄位' });
            return false;
        }

        if (!allMandatoryFieldsFilled)
            return;
        
        if ($('#edit_agree').is(':checked') === false) 
        {
            $.growl.error({ message: '請詳讀並勾選同意條款' });
            return;
        }

        if ($('#edit_agree2').is(':checked') === false) 
        {
            $.growl.error({ message: '請詳讀並勾選所有條款' });
            return;
        }

        try {
            const proof_img = await uploadProof();

            if (!proof_img)
                return;
            var data = {
                account: $('#edit_account').val(),
                password: $('#edit_password').val(),
                email: $('#edit_email').val(),
                chinese_name: $('#edit_chinese_name').val(),
                english_name: $('#edit_english_name').val(),
                gender: $('#edit_gender').val(),
                birthday: moment($('#edit_birthday').val()).format("X"),
                cellphone: $('#edit_cellphone').val(),
                wechat: $('#edit_wechat').val(),
                address: $('#edit_address').val(),
                region: $('#edit_region').val(),
                school: $('#edit_school').val(),

                competition_id: competition_id,
                mentor: $('#edit_mentor').val(),
                group: $('#edit_group').val(),
                date: ($('#edit_date').val()),
                language: $('#edit_language').val(),
                input: $('#edit_input').val(),
                invoice_name: $('#edit_invoice_name').val(),
                invoice_no: $('#edit_invoice_no').val(),
                proof: proof_img
            };
    
            ajax('POST', '/api/users/signup', data, function (a) {
                if (a.success)
                {
                    alert('報名成功');
                }
                if (a.mail)
                {
                    $.growl.error({message: '郵件地址有誤，請確認後聯繫主辦單位'});
                }
            });
            } catch(error) {
        };
    });
        
});
